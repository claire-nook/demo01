<!DOCTYPE html>
<html lang="zh-Hant">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>行動任務處理 - 我的任務 - 任務明細 - 日誌新增</title>

        <style>
            /* ===== 基礎 ===== */
            body {
                font-family: Arial, sans-serif;
                padding: 10px;
                background: #f8f8f8;
            }
            h2 {
                margin-bottom: 1em;
            }
            .back-button {
                background: #666;
                color: #fff;
                border: 0;
                border-radius: 4px;
                padding: 6px 12px;
                font-size: 14px;
                cursor: pointer;
                margin: 0 10px 10px 0;
            }

            /* ===== PC 橫式表單 ===== */
            .pc-form-wrapper {
                max-width: 900px;
                margin: 0 auto;
                background: #fff;
                padding: 20px;
                border-radius: 10px;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            }
            .form-row {
                display: flex;
                align-items: center;
                gap: 10px;
                margin-bottom: 14px;
            }
            .form-row label {
                min-width: 120px;
                font-weight: bold;
                text-align: right;
            }
            .form-row input,
            .form-row select,
            .form-row textarea {
                flex: 1;
                padding: 8px;
                border: 1px solid #ccc;
                border-radius: 4px;
                font-size: 1rem;
                box-sizing: border-box;
            }
            .form-row textarea {
                height: 80px;
            }

            /* ===== Mobile 直式卡片 ===== */
            .mobile-card {
                background: #fff;
                border-radius: 10px;
                padding: 20px;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
                margin: 0 auto;
            }
            .mobile-card label {
                font-weight: bold;
                margin-top: 10px;
                display: block;
            }
            .mobile-card input,
            .mobile-card select,
            .mobile-card textarea {
                width: 100%;
                padding: 8px;
                margin-top: 4px;
                box-sizing: border-box;
                border: 1px solid #ccc;
                border-radius: 4px;
            }
            .mobile-card textarea {
                height: 80px;
            }

            .button-group {
                display: flex;
                justify-content: space-between;
                margin-top: 20px;
                gap: 10px;
            }
            .button {
                flex: 1;
                padding: 10px;
                border: 0;
                color: #fff;
                font-size: 16px;
                border-radius: 4px;
            }
            .button.upload {
                background: #fb8c00;
            }
            .button.cancel {
                background: #555;
            }

            .pc {
                display: block;
            }
            .mobile-only {
                display: none;
            }

            /* ===== 行動版可讀可點 ===== */
            @media (max-width: 767px) {
                .pc {
                    display: none;
                }
                .mobile-only {
                    display: block;
                }
                .back-button {
                    font-size: 16px;
                    padding: 10px;
                    width: 100%;
                    margin-top: 10px;
                }
                input,
                select,
                textarea,
                button {
                    font-size: 16px !important;
                    height: 44px !important;
                    padding: 10px 12px !important;
                    box-sizing: border-box;
                }
                textarea {
                    min-height: 120px !important;
                    height: auto !important;
                    line-height: 1.4;
                }
                label {
                    font-size: 1rem;
                }
                .mobile-card {
                    padding: 16px;
                }
                .button {
                    height: 44px !important;
                    font-size: 16px !important;
                }
                .mobile-card select,
                .mobile-card input,
                .mobile-card textarea {
                    width: 100%;
                    display: block;
                }
            }

            /* ===== 通知對象 chips 與按鈕 ===== */
            .notify-wrap {
                display: flex;
                align-items: center;
                gap: 8px;
                flex: 1;
            }
            .chip-list {
                display: flex;
                flex-wrap: wrap;
                gap: 6px;
            }
            .chip {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                background: #eef2f7;
                border: 1px solid #dbe2ea;
                color: #244;
                padding: 4px 8px;
                border-radius: 999px;
                font-size: 0.9rem;
            }
            .chip .rm {
                cursor: pointer;
                font-weight: bold;
                line-height: 1;
            }
            .btn-sel {
                padding: 8px 10px;
                border: 1px solid #bbb;
                background: #fff;
                border-radius: 6px;
                cursor: pointer;
            }

            /* ===== Modal：單一份最終樣式（PC/手機通用） ===== */
            .modal-mask {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.45);
                display: none;
                z-index: 9999;
            }
            .modal-mask[aria-hidden="false"] {
                display: block;
            }
            .modal-panel {
                background: #fff;
                width: min(900px, 92vw);
                max-height: 84vh;
                margin: 6vh auto;
                border-radius: 12px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }
            .modal-head {
                padding: 12px 16px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-bottom: 1px solid #eee;
                font-weight: 700;
            }
            .modal-body {
                flex: 1;
                display: flex;
                gap: 12px;
                padding: 12px;
                overflow: hidden;
            }
            .modal-foot {
                position: sticky;
                bottom: 0;
                background: #fff;
                border-top: 1px solid #eee;
                padding: 10px 12px;
                display: flex;
                justify-content: flex-end;
                gap: 8px;
            }

            .col {
                flex: 1;
                border: 1px solid #eef0f3;
                border-radius: 10px;
                display: flex;
                flex-direction: column;
                min-width: 0;
                overflow: hidden;
            }
            .col-head {
                padding: 8px 10px;
                background: #f8fafc;
                border-bottom: 1px solid #eef0f3;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            .col-body {
                padding: 6px 8px;
                overflow: auto;
                -webkit-overflow-scrolling: touch;
            }
            .unit-item,
            .user-item {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 8px 6px;
                border-bottom: 1px dashed #f1f3f6;
            }
            .unit-item input[type="checkbox"],
            .user-item input[type="checkbox"] {
                width: 18px;
                height: 18px;
            }
            .search {
                width: 100%;
                padding: 8px 10px;
                border: 1px solid #e2e8f0;
                border-radius: 8px;
            }

            @media (max-width: 767px) {
                .modal-panel {
                    width: 100vw;
                    height: 100vh;
                    margin: 0;
                    border-radius: 0;
                    max-height: none;
                }
                .modal-body {
                    flex: 1;
                    flex-direction: column;
                    gap: 10px;
                    padding: 10px;
                }
                .col-body {
                    flex: 1;
                }
            }

            /* ===== Split Button（沿用 99 原功能但視覺契合 02） ===== */
            .split {
                display: inline-flex;
                position: relative;
                vertical-align: middle;
                border-radius: 6px;
                overflow: visible;
                border: 1px solid #bbb;
                background: #fff;
            }
            .split > button {
                border: 0;
                padding: 8px 12px;
                font-size: 14px;
                cursor: pointer;
                background: #fff;
            }
            .split > button:first-child {
                background: #fb8c00;
                color: #fff;
            }
            .split > button:last-child {
                width: 36px;
                border-left: 1px solid rgba(255, 255, 255, 0.35);
                background: #fb8c00;
                color: #fff;
            }
            .split[aria-disabled="true"] {
                opacity: 0.6;
                pointer-events: none;
            }

            .menu {
                position: absolute;
                top: calc(100% + 6px);
                left: 0;
                min-width: 260px;
                background: #fff;
                border: 1px solid #ddd;
                border-radius: 10px;
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
                padding: 6px;
                display: none;
                z-index: 30;
            }
            .menu.open {
                display: block;
            }
            .menu .search {
                padding: 6px;
                border-bottom: 1px solid #eee;
            }
            .menu .search input {
                width: 100%;
                padding: 8px 10px;
                border: 1px solid #ddd;
                border-radius: 6px;
                font-size: 14px;
            }
            .menu .item {
                width: 100%;
                text-align: left;
                border: 0;
                background: #fff;
                padding: 9px 10px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
            }
            .menu .item:hover {
                background: #f5f5f5;
            }
            .menu {
                z-index: 1000;
            }

            /* iOS 表單正常化：修掉灰底與不一致高度，但保留原生挑選器 */
            @media screen and (max-width: 767px) {
                /* 統一外觀：日期/時間欄位 */
                input[type="date"],
                input[type="time"],
                input[type="datetime-local"] {
                    background-color: #fff !important;
                    color: #222;
                    -webkit-text-fill-color: #222; /* iOS 內層字色 */
                    border: 1px solid #ccc;
                    border-radius: 8px;
                    width: 100%;
                    box-sizing: border-box;
                    /* 跟 select 對齊的尺寸 */
                    min-height: 44px; /* 手指友善高度 */
                    padding: 10px 12px; /* 與 select 同步 */
                    line-height: 1.2;
                }

                /* select 建議自訂外觀，避免系統灰感與高度不一致 */
                select {
                    -webkit-appearance: none;
                    appearance: none;
                    background-color: #fff !important;
                    color: #222;
                    border: 1px solid #ccc;
                    border-radius: 8px;
                    width: 100%;
                    box-sizing: border-box;
                    min-height: 44px;
                    padding: 10px 36px 10px 12px; /* 右側留給箭頭 */
                    line-height: 1.2;
                    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%23666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>');
                    background-repeat: no-repeat;
                    background-position: right 0.6rem center;
                    background-size: 1rem;
                }

                /* 真正唯讀/停用才灰底，語意明確 */
                input[readonly],
                textarea[readonly],
                input[disabled],
                select[disabled] {
                    background-color: #f2f2f2 !important;
                    color: #888 !important;
                    border-color: #ddd !important;
                }

                /*  query 頁有並排的日期欄，避免 iOS 內建寬度撐爆 */
                .inline-date input {
                    min-width: 0;
                }
            }
			@media screen and (max-width: 767px) {
			  /* 指定行動版的內容欄位更高，權重比元素選擇器高 */
			  #contentM {
				min-height: 200px !important; /* 想多高就改這裡 */
				height: auto !important;      /* 保留自動增高行為 */
				line-height: 1.4;
			  }
			}            
        </style>
    </head>
    <body>
        <button class="back-button pc" onclick="goBack()">← 返回</button>
        <div class="mobile-only"><button class="back-button" onclick="goBack()">← 返回</button></div>

        <h2>任務編號 <strong>123456</strong></h2>

        <!-- PC 版表單 -->
        <div class="pc-form-wrapper pc" id="log-pc">
            <div class="form-row">
                <label>賠案號碼：</label>
                <div>10000001</div>
            </div>
            <div class="form-row">
                <label>車牌號碼：</label>
                <div>1234-BB</div>
            </div>

            <div class="form-row">
                <label for="processItem">處理項目：</label>
                <select id="processItem">
                    <option>Notification 損失通知</option>
                    <option>Coverage 承保範圍</option>
                    <option>Initial Contact 初次聯絡</option>
                    <option>Investigation 事故調查</option>
                    <option>Case Strategy 賠案處理策略</option>
                    <option>Vendor Mgmt 協力車商管理</option>
                    <option>Evaluation 各項賠款估價</option>
                    <option>Counter Fraud 反詐欺</option>
                    <option>Reserving 預估損失金額</option>
                    <option>Neg & Settlem 談判處理</option>
                    <option>Litig. Mgmt 訴訟管理</option>
                    <option>Recovery 追償</option>
                    <option>File Mgmt 檔案管理</option>
                    <option>Quality Assurance 賠案檢核</option>
                    <option>Salvage 殘餘物作業</option>
                    <option>客戶文件上傳/留言</option>
                </select>
            </div>

            <div class="form-row"><label for="contactPerson">被聯絡人：</label><input id="contactPerson" type="text" /></div>

            <div class="form-row">
                <label>內容範本：</label>
                <div class="split" id="tplSplit" aria-disabled="false">
                    <button id="tplMain">套用範本</button>
                    <button id="tplToggle" aria-expanded="false" aria-haspopup="true">▾</button>
                    <div class="menu" id="tplMenu" role="menu" aria-hidden="true">
                        <div class="search"><input id="tplSearch" type="search" placeholder="搜尋範本關鍵字" /></div>
                        <!-- 範本列表以 JS 動態產生（包含「不套用範本」在第一項） -->
                    </div>
                </div>
            </div>

            <div class="form-row"><label for="content">內容：</label><textarea id="content"></textarea></div>

            <div class="form-row">
                <label>通知對象：</label>
                <div class="notify-wrap">
                    <div id="notifyChips" class="chip-list"></div>
                    <button type="button" class="btn-sel" onclick="openNotifyModal()">選擇</button>
                    <input type="hidden" id="notifyUserIds" name="notifyUserIds" value="" />
                </div>
            </div>

            <div class="button-group">
                <button class="button upload" onclick="submitLog()">送出</button>
                <button class="button cancel" onclick="clearForm()">取消</button>
            </div>
        </div>

        <!-- Mobile 版表單 -->
        <div class="mobile-card mobile-only" id="log-mobile">
            <div><strong>賠案號碼：</strong>10000001</div>
            <div><strong>車牌號碼：</strong>1234-BB</div>

            <label>處理項目：</label>
            <select>
                <option>Notification 損失通知</option>
                <option>Coverage 承保範圍</option>
                <option>Initial Contact 初次聯絡</option>
                <option>Investigation 事故調查</option>
                <option>Case Strategy 賠案處理策略</option>
                <option>Vendor Mgmt 協力車商管理</option>
                <option>Evaluation 各項賠款估價</option>
                <option>Counter Fraud 反詐欺</option>
                <option>Reserving 預估損失金額</option>
                <option>Neg & Settlem 談判處理</option>
                <option>Litig. Mgmt 訴訟管理</option>
                <option>Recovery 追償</option>
                <option>File Mgmt 檔案管理</option>
                <option>Quality Assurance 賠案檢核</option>
                <option>Salvage 殘餘物作業</option>
                <option>客戶文件上傳/留言</option>
            </select>

            <label>被聯絡人：</label>
            <input id="contactPersonM" type="text" />

            <label>內容範本：</label>
            <div class="split" id="tplSplitM" aria-disabled="false">
                <button id="tplMainM">套用範本</button>
                <button id="tplToggleM" aria-expanded="false" aria-haspopup="true">▾</button>
                <div class="menu" id="tplMenuM" role="menu" aria-hidden="true">
                    <div class="search"><input id="tplSearchM" type="search" placeholder="搜尋範本關鍵字" /></div>
                </div>
            </div>

            <label>內容：</label>
            <textarea id="contentM"></textarea>

            <label>通知對象：</label>
            <div class="notify-wrap" style="gap: 8px; flex-wrap: wrap;">
                <div id="notifyChipsM" class="chip-list" style="width: 100%;"></div>
                <button type="button" class="btn-sel" onclick="openNotifyModal()">選擇</button>
                <input type="hidden" id="notifyUserIdsM" name="notifyUserIdsM" value="" />
            </div>

            <div class="button-group">
                <button class="button upload" onclick="submitLog()">送出</button>
                <button class="button cancel" onclick="clearForm()">取消</button>
            </div>
        </div>

        <!-- 選擇通知對象 MODAL -->
        <div id="notifyModal" class="modal-mask" aria-hidden="true">
            <div class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="notifyTitle">
                <div class="modal-head">
                    <div id="notifyTitle">選擇通知對象</div>
                    <button class="btn-sel" onclick="closeNotifyModal()">✕</button>
                </div>
                <div class="modal-body">
                    <section class="col">
                        <div class="col-head"><span>單位</span></div>
                        <div class="col-body" id="unitList"></div>
                    </section>
                    <section class="col">
                        <div class="col-head" style="gap: 8px; align-items: center;">
                            <span>人員</span>
                            <input id="userSearch" class="search" placeholder="輸入姓名或帳號搜尋" />
                        </div>
                        <div class="col-body" id="userList"></div>
                    </section>
                </div>
                <div class="modal-foot">
                    <button class="btn-sel" onclick="clearNotifySelection()">清除</button>
                    <button class="btn-sel" onclick="closeNotifyModal()">取消</button>
                    <button class="button upload" onclick="applyNotifySelection()">加入</button>
                </div>
            </div>
        </div>

        <!-- 套用模式 Modal（與 02 一致的視覺） -->
        <div id="modeModal" class="modal-mask" aria-hidden="true">
            <div class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="modeTitle">
                <div class="modal-head" id="modeTitle">目前內容非空，請選擇套用方式</div>
                <div class="modal-body">
                    <label style="display: block; margin-bottom: 8px;"><input type="radio" name="applyMode" value="replace" checked /> 取代目前內容</label>
                    <label style="display: block; margin-bottom: 8px;"><input type="radio" name="applyMode" value="append" /> 追加到末尾</label>
                    <label style="display: block; margin-bottom: 8px;"><input type="radio" name="applyMode" value="insert" /> 插入游標處</label>
                </div>
                <div class="modal-foot">
                    <button class="btn-sel" id="modeCancel">取消</button>
                    <button class="btn-primary" id="modeOk">套用</button>
                </div>
            </div>
        </div>

        <script>
            /* ===== 導航與表單 ===== */
            function goBack() {
                location.href = "02.task_detail_proc.html";
            }
            function clearForm() {
                if (confirm("是否取消新增日誌，返回任務明細頁？")) location.href = "02.task_detail_proc.html";
            }
            function submitLog() {
                if (confirm("請確認是否將日誌新增至賠案裡？")) {
                    alert("新增完成");
                    location.href = "02.task_detail_proc.html";
                }
            }

            /* ===== 假資料 ===== */
            const MOCK = {
                units: [
                    { id: "U01", name: "北區理賠室" },
                    { id: "U02", name: "中區理賠一室" },
                    { id: "U03", name: "中區理賠二室" },
                    { id: "U04", name: "中區理賠三室" },
                    { id: "U05", name: "中區理賠四室" },
                    { id: "U06", name: "南區理賠一室" },
                    { id: "U07", name: "南區理賠二室" },
                ],
                usersByUnit: {
                    U01: [
                        { id: "emp001", name: "張三" },
                        { id: "emp002", name: "李四" },
                        { id: "emp003", name: "王五" },
                    ],
                    U02: [
                        { id: "emp101", name: "陳六" },
                        { id: "emp102", name: "趙七" },
                    ],
                    U03: [
                        { id: "emp201", name: "林八" },
                        { id: "emp202", name: "周九" },
                    ],
                    U04: [
                        { id: "emp301", name: "林甜甜" },
                        { id: "emp302", name: "黃閒閒" },
                    ],
                    U05: [
                        { id: "emp401", name: "李花花" },
                        { id: "emp402", name: "柳白白" },
                    ],
                    U06: [
                        { id: "emp501", name: "任明明" },
                        { id: "emp502", name: "張心心" },
                    ],
                    U07: [
                        { id: "emp601", name: "田小花" },
                        { id: "emp602", name: "塗小草" },
                    ],
                },
            };

            /* ===== 選人 Modal 狀態與行為（TO-only） ===== */
            //const state = { unitChecked: new Set(), userChecked: new Map(), search: "" };
            const notifyState = { unitChecked: new Set(), userChecked: new Map(), search: "" };

            function openNotifyModal() {
                document.body.style.overflow = "hidden";
                document.getElementById("notifyModal").setAttribute("aria-hidden", "false");
                renderUnitList();
                renderUserList(); // 初始空白
                const inp = document.getElementById("userSearch");
                if (inp) {
                    inp.value = "";
                    inp.oninput = () => {
                        notifyState.search = inp.value.trim();
                        renderUserList();
                    };
                }
            }
            function closeNotifyModal() {
                document.body.style.overflow = "";
                document.getElementById("notifyModal").setAttribute("aria-hidden", "true");
            }

            function renderUnitList() {
                const box = document.getElementById("unitList");
                box.innerHTML = "";
                (MOCK.units || []).forEach((u) => {
                    const row = document.createElement("div");
                    row.className = "unit-item";
                    const ck = document.createElement("input");
                    ck.type = "checkbox";
                    ck.checked = notifyState.unitChecked.has(u.id);
                    ck.onchange = () => {
                        ck.checked ? notifyState.unitChecked.add(u.id) : notifyState.unitChecked.delete(u.id);
                        renderUserList();
                    };
                    const lab = document.createElement("label");
                    lab.textContent = u.name;
                    lab.style.cursor = "pointer";
                    row.appendChild(ck);
                    row.appendChild(lab);
                    box.appendChild(row);
                });
            }

            function renderUserList() {
                const box = document.getElementById("userList");
                box.innerHTML = "";
                const selectedUnitIds = notifyState.unitChecked.size ? Array.from(notifyState.unitChecked) : [];
                if (!selectedUnitIds.length && !notifyState.search) {
                    const tip = document.createElement("div");
                    tip.style.color = "#888";
                    tip.style.padding = "8px";
                    tip.textContent = "請先勾選左側單位，或用上方搜尋";
                    box.appendChild(tip);
                    return;
                }
                const pool = [];
                const pushUsers = (uid) => (MOCK.usersByUnit[uid] || []).forEach((p) => pool.push(p));
                if (selectedUnitIds.length) selectedUnitIds.forEach(pushUsers);
                else Object.keys(MOCK.usersByUnit).forEach(pushUsers);
                const q = notifyState.search;
                const list = q ? pool.filter((p) => p.name.includes(q) || p.id.includes(q)) : pool;
                list.forEach((p) => {
                    const row = document.createElement("div");
                    row.className = "user-item";
                    const ck = document.createElement("input");
                    ck.type = "checkbox";
                    ck.checked = notifyState.userChecked.has(p.id);
                    ck.onchange = () => {
                        ck.checked ? notifyState.userChecked.set(p.id, { id: p.id, name: p.name }) : notifyState.userChecked.delete(p.id);
                    };
                    const lab = document.createElement("label");
                    lab.textContent = p.name;
                    lab.style.cursor = "pointer";
                    row.appendChild(ck);
                    row.appendChild(lab);
                    box.appendChild(row);
                });
                if (!list.length) {
                    const empty = document.createElement("div");
                    empty.style.color = "#888";
                    empty.style.padding = "8px";
                    empty.textContent = "沒有符合條件的人員";
                    box.appendChild(empty);
                }
            }

            function clearNotifySelection() {
                notifyState.userChecked.clear();
                renderUserList();
                applyNotifySelection(true);
            }

            function applyNotifySelection(keepOpen) {
                const users = Array.from(notifyState.userChecked.values());
                fillChips("notifyChips", "notifyUserIds", users);
                fillChips("notifyChipsM", "notifyUserIdsM", users);
                if (!keepOpen) closeNotifyModal();
            }

            function fillChips(chipsId, hiddenId, users) {
                const wrap = document.getElementById(chipsId);
                if (wrap) {
                    wrap.innerHTML = "";
                    users.forEach((u) => {
                        const chip = document.createElement("span");
                        chip.className = "chip";
                        chip.innerHTML = `${u.name}<span class="rm" title="移除">×</span>`;
                        chip.querySelector(".rm").onclick = () => {
                            notifyState.userChecked.delete(u.id);
                            chip.remove();
                            setHiddenBoth(Array.from(notifyState.userChecked.keys()));
                            if (document.getElementById("notifyModal").getAttribute("aria-hidden") === "false") renderUserList();
                        };
                        wrap.appendChild(chip);
                    });
                }
                const ids = users.map((u) => u.id).join(",");
                const hid = document.getElementById(hiddenId);
                if (hid) hid.value = ids;
                setHiddenBoth(users.map((u) => u.id));
            }

            function setHiddenBoth(ids) {
                const v = (ids || []).join(",");
                const a = document.getElementById("notifyUserIds");
                if (a) a.value = v;
                const b = document.getElementById("notifyUserIdsM");
                if (b) b.value = v;
            }

            /* ===== 內嵌 JSON：由 SAMPLE.md 轉換而來（沿用 99 的資料） ===== */
            const TEMPLATES = [
                { id: "01", name: "體傷初步", body: "一、事故摘要：\n二、責任研判：\n三、傷者性別、年齡：\n四、傷者職業、收入：\n五、傷者傷情摘要：\n六、傷者請求項目：\n七、傷者要求總金額：\n八、賠案處理策略：\n九、建議準備金提列金額：" },
                {
                    id: "02",
                    name: "重大車財損初步",
                    body: "一、事故摘要：\n二、責任初判：\n三、保車駕照狀態：\n四、投保險種/保額：\n五、本 / 財車修車車\n六、本 / 財車初估金額：\n七、是否需申請技術人員：\n八、賠案處理策略：\n九、建議準備金提列金額：",
                },
                { id: "03", name: "單強/死殘初步", body: "一、事故摘要：\n二、傷情摘要：\n三、符合殘廢等級-項目說明：\n四、建議準備金提列金額：\n五、其他：" },
                { id: "04", name: "其他通報", body: "一、事故摘要：\n二、損失情形：\n三、通報事項：\n四、建議準備金提列金額：" },
                { id: "05", name: "視訊勘車", body: "視訊勘車 保車/財車\n1、車號：\n2、車廠︰\n3、專員、電話：\n4、核批總金額：\n5、備註：" },
                { id: "06", name: "視訊追加", body: "視訊追加 保車/財車\n1、車號：\n2、核批總金額：\n3、備註：" },
                { id: "07", name: "重大現勘", body: "視訊重大現勘 保車/財車\n1、車號：\n2、車廠︰\n3、專員、電話：\n4、估價金額：\n視訊未核批，安排現勘" },
            ];

            //const state = { templates: TEMPLATES, selectedTemplate: null, pendingText: '' };
            const tplState = { templates: TEMPLATES, selectedTemplate: null, pendingText: "" };

            document.addEventListener("DOMContentLoaded", () => {
                buildMenu("tplMenu", "tplSearch", false);
                bindSplitButton("tplSplit", "tplMain", "tplToggle", "tplMenu", "content");
                buildMenu("tplMenuM", "tplSearchM", true);
                bindSplitButton("tplSplitM", "tplMainM", "tplToggleM", "tplMenuM", "contentM");
            });

            /* ===== 建立 Split Button 下拉選單 ===== */
            function buildMenu(menuId, searchId, isMobile) {
                const menu = document.getElementById(menuId);
                // 清舊項
                menu.querySelectorAll(".item").forEach((el) => el.remove());
                // 第一項：不套用範本
                const noneBtn = document.createElement("button");
                noneBtn.className = "item";
                noneBtn.textContent = "不套用範本";
                noneBtn.onclick = () => closeMenu(menuId, isMobile ? "tplToggleM" : "tplToggle");
                menu.appendChild(noneBtn);
                // 其餘範本
                for (const t of tplState.templates) {
                    const btn = document.createElement("button");
                    btn.className = "item";
                    btn.textContent = t.name;
                    btn.onclick = () => onTemplatePicked(t, isMobile);
                    menu.appendChild(btn);
                }
                // 搜尋
                const search = document.getElementById(searchId);
                if (search) {
                    search.addEventListener("input", () => {
                        const q = search.value.trim();
                        Array.from(menu.querySelectorAll(".item")).forEach((btn, idx) => {
                            if (idx === 0) return; // 保留「不套用範本」
                            btn.style.display = !q || btn.textContent.includes(q) ? "" : "none";
                        });
                    });
                }
            }

            function bindSplitButton(splitId, mainId, toggleId, menuId, textareaId) {
                const main = document.getElementById(mainId);
                const toggle = document.getElementById(toggleId);
                const menu = document.getElementById(menuId);
                const split = document.getElementById(splitId);

                const open = () => {
                    menu.classList.add("open");
                    toggle.setAttribute("aria-expanded", "true");
                };
                const close = () => {
                    menu.classList.remove("open");
                    toggle.setAttribute("aria-expanded", "false");
                };

                main.addEventListener("click", open);
                toggle.addEventListener("click", () => (menu.classList.contains("open") ? close() : open()));
                document.addEventListener("click", (e) => {
                    if (!split.contains(e.target)) close();
                });
                // 將關聯的 textarea 存在元素 dataset 中
                split.dataset.textarea = textareaId;
            }

            function closeMenu(menuId, toggleId) {
                const menu = document.getElementById(menuId);
                const toggle = document.getElementById(toggleId);
                if (menu) menu.classList.remove("open");
                if (toggle) toggle.setAttribute("aria-expanded", "false");
            }

            function collectVars() {
                const getTxt = (id) => document.getElementById(id)?.textContent?.trim() || "";
                const getVal = (id) => document.getElementById(id)?.value?.trim() || "";
                return {
                    CLAIM_NO: getTxt("claimNo") || getTxt("claimNoM"),
                    PLATE_NO: getTxt("plateNo") || getTxt("plateNoM"),
                    CONTACT_NAME: getVal("contactPerson") || getVal("contactPersonM"),
                    DATE: new Date().toISOString().slice(0, 10),
                };
            }

            function onTemplatePicked(tpl, isMobile) {
                const rep = collectVars();
                let text = tpl.body.replace(/\{\{(\w+)\}\}/g, (_, k) => rep[k] ?? `{{${k}}}`);
                tplState.selectedTemplate = tpl;
                tplState.pendingText = text;
                const ta = document.getElementById(isMobile ? "contentM" : "content");
                if (!ta.value.trim()) {
                    applyToTextarea(ta, "replace");
                } else {
                    openModeModal(ta);
                }
            }

            /* ===== Modal 開關與套用 ===== */
            function openModeModal(targetTextarea) {
                const mask = document.getElementById("modeModal");
                mask.setAttribute("aria-hidden", "false");
                const okBtn = document.getElementById("modeOk");
                const cancelBtn = document.getElementById("modeCancel");
                // 移除既有 listener 避免多次綁定
                const okClone = okBtn.cloneNode(true);
                const cancelClone = cancelBtn.cloneNode(true);
                okBtn.parentNode.replaceChild(okClone, okBtn);
                cancelBtn.parentNode.replaceChild(cancelClone, cancelBtn);
                okClone.addEventListener("click", () => {
                    const mode = document.querySelector('input[name="applyMode"]:checked').value;
                    applyToTextarea(targetTextarea, mode);
                    closeModeModal();
                });
                cancelClone.addEventListener("click", closeModeModal);
            }

            function closeModeModal() {
                document.getElementById("modeModal").setAttribute("aria-hidden", "true");
            }

            function applyToTextarea(ta, mode) {
                const txt = tplState.pendingText || "";
                if (mode === "replace") {
                    ta.value = txt;
                    ta.selectionStart = ta.selectionEnd = 0;
                } else if (mode === "append") {
                    ta.value = (ta.value ? ta.value + "\n" : "") + txt;
                    ta.selectionStart = ta.selectionEnd = 0;
                } else if (mode === "insert") {
                    const start = ta.selectionStart ?? ta.value.length;
                    const end = ta.selectionEnd ?? ta.value.length;
                    ta.value = ta.value.slice(0, start) + txt + ta.value.slice(end);
                    const caret = start + txt.length;
                    requestAnimationFrame(() => {
                        ta.selectionStart = ta.selectionEnd = caret;
                        ta.focus();
                    });
                    return;
                }
                ta.focus();
            }
        </script>
    </body>
</html>
