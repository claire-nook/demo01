<!DOCTYPE html>
<html lang="zh-Hant">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>行動任務處理 - 資料補傳 - 賠案明細（美化版）</title>
        <style>
            :root {
                --bg: #f5f6f8;
                --card: #fff;
                --text: #111827;
                --muted: #6b7280;
                --line: #e5e7eb;
                --brand: #2563eb;
                --brand-weak: #eff6ff;
                --ok: #059669;
                --warn: #ea580c;
                --muted-bg: #f3f4f6;
                --radius: 10px;
                --r-sm: 8px;
                --shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
                --fs-xxs: 0.78rem;
                --fs-xs: 0.86rem;
                --fs-sm: 0.92rem;
                --fs-md: 1rem;
                --fs-lg: 1.125rem;
                --fs-xl: 1.25rem;
                --gap-1: 6px;
                --gap-2: 10px;
                --gap-3: 14px;
                --gap-4: 16px;
                --gap-5: 20px;
                --keyw: 140px;
                --keyw-m: 110px;
            }

            /* base */
            html,
            body {
                height: 100%;
            }
            body {
                font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans TC", "PingFang TC", sans-serif;
                margin: 0;
                padding: 20px;
                background: var(--bg);
                color: var(--text);
            }
            h2 {
                margin: 0 0 12px;
                display: flex;
                align-items: center;
                gap: 10px;
                font-size: var(--fs-lg);
            }

            /* card */
            .card {
                background: var(--card);
                padding: 18px;
                border-radius: var(--radius);
                box-shadow: var(--shadow);
                margin: 0 auto 16px;
                max-width: 1000px;
            }

            /* buttons */
            .btn-row {
                display: flex;
                justify-content: center;
                gap: 10px;
                flex-wrap: wrap;
                margin: 18px auto;
                max-width: 1000px;
            }
            .btn {
                padding: 10px 16px;
                border: none;
                border-radius: 8px;
                font-size: var(--fs-md);
                color: #fff;
                cursor: pointer;
            }
            .btn-primary {
                background: var(--brand);
            }

            /* tabs */
            .tab-card {
                padding: 0;
            }
            .tab-nav {
                display: flex;
                gap: 6px;
                overflow-x: auto;
                white-space: nowrap;
                border-bottom: 1px solid var(--line);
                padding: 10px;
                border-top-left-radius: var(--radius);
                border-top-right-radius: var(--radius);
                background: var(--card);
            }
            .tab-btn {
                border: none;
                background: var(--muted-bg);
                color: #111;
                padding: 8px 14px;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
            }
            .tab-btn[aria-selected="true"] {
                background: #fff;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
            }
            .tab-panels {
                padding: 16px 20px 20px;
            }
            .tab-panel {
                display: none;
            }
            .tab-panel.active {
                display: block;
            }

            /* kv grid */
            .kv {
                display: grid;
                grid-template-columns: var(--keyw) 1fr;
                gap: 8px 16px;
            }
            .k {
                color: var(--muted);
                font-size: var(--fs-sm);
                text-align: right;
            }
            .v {
                font-size: var(--fs-md);
            }
            /* sub-cards for arrays */
            .sub-card {
                border: 1px solid var(--line);
                border-radius: var(--r-sm);
                padding: 12px 14px;
                margin: 10px 0;
                background: #fafafa;
            }
            .sub-title {
                font-weight: 700;
                margin: 4px 0 12px;
            }

            /* pretty header */
            .head {
                padding: 16px 18px;
            }
            .head-top {
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 10px;
                margin-bottom: 8px;
            }
            .claim-strong {
                font-size: var(--fs-xl);
                font-weight: 800;
                letter-spacing: 0.5px;
            }
            .muted {
                color: var(--muted);
            }

            /* chips & badges */
            .chip {
                display: inline-block;
                padding: 2px 8px;
                border-radius: 999px;
                background: var(--muted-bg);
                font-size: var(--fs-xs);
                margin-right: 6px;
            }
            .badge {
                display: inline-block;
                padding: 2px 10px;
                border-radius: 999px;
                font-size: var(--fs-xs);
                border: 1px solid var(--line);
            }
            .badge-processing {
                background: #fff7ed;
                color: #9a3412;
                border-color: #fed7aa;
            }
            .badge-done {
                background: #ecfdf5;
                color: #065f46;
                border-color: #a7f3d0;
            }

            /* truncation */
            .clamp-2 {
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
                overflow: hidden;
            }
            .link-sm {
                font-size: var(--fs-xs);
                margin-left: 8px;
                background: none;
                border: none;
                color: var(--brand);
                cursor: pointer;
            }

            /* journal kv smaller */
            .kv.kv-tight {
                gap: 6px 14px;
            }

            /* mobile */
            @media (max-width: 767px) {
                body {
                    padding: 16px;
                }
                .kv {
                    grid-template-columns: var(--keyw-m) 1fr;
                }
                .k {
                    text-align: left;
                }
                .btn {
                    width: 100%;
                }
                .chip {
                    margin-bottom: 6px;
                }
                .head-top {
                    align-items: flex-start;
                }
                .tab-btn {
                    font-size: 1.05rem;
                    padding: 10px 10px;
                    min-height: 36px;
                    line-height: 1.4;
                }
            }

            .divider {
                grid-column: 1 / -1;
                height: 1px;
                background: var(--line);
                margin: 8px 0 6px;
            }
            .basic-sep {
                border: 0;
                border-top: 1px dashed #d8dbe0;
                margin: 14px 0 18px;
            }

            /* key-value grid，與基本資料一致 */
            .kv-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px 18px;
                margin-bottom: 12px;
            }
            .kv-row {
                display: grid;
                grid-template-columns: 120px 1fr;
                align-items: center;
                min-height: 32px;
                background: #fff;
                padding: 6px 10px;
                border: 1px solid #eef0f3;
                border-radius: 8px;
            }
            .kv-key {
                color: #6b7280;
                font-size: 0.92rem;
            }
            .kv-val {
                font-weight: 600;
                word-break: break-all;
            }

            /* 卡片外觀（與基本資料一致） */
            .info-card {
                border: 1px solid #e6e9ef;
                border-radius: 12px;
                background: #fafbfc;
                margin: 14px 0 8px;
                overflow: hidden;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
            }
            .info-card-head {
                padding: 10px 12px;
                background: #f3f5f8;
                border-bottom: 1px solid #e6e9ef;
                display: flex;
                align-items: center;
                justify-content: space-between;
                cursor: default;
            }
            .info-card-title {
                font-weight: 700;
                font-size: 1rem;
                letter-spacing: 0.02em;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            .info-card .kv-grid {
                padding: 12px;
                margin-bottom: 0;
            }
            /* 可收合卡片 */
            .collapsible {
                overflow: hidden;
            }
            .collapsible .info-card-head {
                cursor: pointer;
            }
            .caret {
                width: 0;
                height: 0;
                border-left: 6px solid transparent;
                border-right: 6px solid transparent;
                border-top: 6px solid #6b7280;
                transform: rotate(-90deg);
                transition: transform 0.18s ease;
            }
            .is-open .caret {
                transform: rotate(0deg);
            }
            .count-badge {
                font-size: 0.86rem;
                color: #374151;
                background: #eef2f7;
                border: 1px solid #e2e8f0;
                padding: 2px 8px;
                border-radius: 999px;
            }
            .ghost {
                display: none;
            }

            /* 多筆清單：粗體標題 + 無框欄位 + 分隔線 */
            .sub-collection {
                padding: 10px 12px;
            }
            .item-title {
                font-weight: 800;
                font-size: 1.02rem;
                padding: 2px 0 6px;
            }
            .sub-divider {
                border: 0;
                border-top: 1px dashed #e3e7ee;
                margin: 10px 0;
            }

            /* 無框的 key-value（與基本資料上半部一致） */
            .kv-plain .kv-row {
                background: transparent;
                border: 0;
                border-radius: 0;
                padding: 2px 0;
            }
            .kv-plain .kv-row + .kv-row {
                border-top: 1px dotted #eceff3;
                padding-top: 6px;
                margin-top: 6px;
            }

            /* 無框的 key-value（與基本資料上半部一致） */
            .kv-plain .kv-row {
                background: transparent;
                border: 0;
                border-radius: 0;
                padding: 2px 0;
            }
            .kv-plain .kv-row + .kv-row {
                border-top: 1px dotted #eceff3;
                padding-top: 6px;
                margin-top: 6px;
            }

            /* 多筆清單的視覺層次 */
            .sub-collection {
                padding: 10px 12px;
            }
            .sub-item {
                border: 1px solid #e6e9ef;
                border-radius: 10px;
                background: #fff;
                margin: 10px 0;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
                border-left: 4px solid #c7d2fe;
            }
            .sub-item > .sub-title {
                background: #f8fafc;
                border-bottom: 1px solid #e6e9ef;
                padding: 8px 10px;
                font-weight: 700;
            }
            .sub-item .kv-grid {
                padding: 8px 10px;
            }

            @media (max-width: 767px) {
                .kv-grid {
                    grid-template-columns: 1fr;
                    gap: 8px;
                }
                .kv-row {
                    grid-template-columns: 90px 1fr;
                    min-height: 38px;
                    padding: 8px 10px;
                }
                .info-card-title {
                    font-size: 0.98rem;
                }
            }

            /* 基本資料：極簡模式（保留一致性） */
            #panel-basic.basic-compact .kv-grid {
                gap: 6px 16px;
                margin-bottom: 10px;
            }
            #panel-basic.basic-compact .kv-row {
                background: transparent;
                border: 0;
                border-radius: 0;
                padding: 2px 0;
                min-height: unset;
                display: grid;
                grid-template-columns: 92px 1fr;
            }
            #panel-basic.basic-compact .kv-row + .kv-row {
                border-top: 1px dotted #eceff3;
                padding-top: 6px;
                margin-top: 6px;
            }
            #panel-basic.basic-compact .kv-key {
                color: #8a94a3;
                font-weight: 500;
                font-size: 0.92rem;
            }
            #panel-basic.basic-compact .kv-val {
                font-weight: 600;
                word-break: break-word;
            }
            #panel-basic.basic-compact .info-card {
                border: 1px solid #e6e9ef;
                background: #f7f9fb;
                margin: 12px 0 10px;
                border-radius: 12px;
            }
            #panel-basic.basic-compact .info-card .kv-grid {
                padding: 10px 12px;
            }
            #panel-basic.basic-compact .info-card .kv-row {
                background: transparent;
                border: 0;
                border-radius: 0;
                padding: 2px 0;
                grid-template-columns: 72px 1fr;
            }
            #panel-basic.basic-compact .info-card .kv-row + .kv-row {
                border-top: 1px dotted #e9edf2;
                padding-top: 6px;
                margin-top: 6px;
            }

            @media (max-width: 767px) {
                #panel-basic.basic-compact .kv-grid {
                    grid-template-columns: 1fr;
                    gap: 6px;
                }
                #panel-basic.basic-compact .kv-row {
                    grid-template-columns: 88px 1fr;
                    padding: 4px 0;
                }
                #panel-basic.basic-compact .info-card .kv-row {
                    grid-template-columns: 68px 1fr;
                }
            }
        </style>
    </head>
    <body>
        <h2>賠案明細</h2>

        <!-- Header 美化版 -->
        <div class="card head" id="claim-header-card"></div>

        <!-- 中間：二顆按鈕（保持不動） -->
        <div class="btn-row">
            <button class="btn btn-primary" onclick="location.href='03.claim_log_upload.html'">日誌新增</button>
            <button class="btn btn-primary" onclick="location.href='03.claim_file_upload.html'">檔案上傳</button>
        </div>

        <!-- Tabs -->
        <div class="card tab-card" role="region" aria-label="賠案資訊切換">
            <div class="tab-nav" role="tablist">
                <button class="tab-btn" role="tab" aria-selected="true" aria-controls="panel-basic" id="tab-basic">基本資料</button>
                <button class="tab-btn" role="tab" aria-selected="false" aria-controls="panel-accident" id="tab-accident">事故資料</button>
                <button class="tab-btn" role="tab" aria-selected="false" aria-controls="panel-coverage" id="tab-coverage">承保內容</button>
                <button class="tab-btn" role="tab" aria-selected="false" aria-controls="panel-log" id="tab-log">日誌</button>
            </div>
            <div class="tab-panels">
                <section id="panel-basic" class="tab-panel active" role="tabpanel" aria-labelledby="tab-basic">
                    <div class="kv" id="basicKV"></div>
                </section>

                <!-- 事故資料：改成與基本資料一致的風格 + 可收合卡片 -->
                <section id="panel-accident" class="tab-panel" role="tabpanel" aria-labelledby="tab-accident">
                    <div id="accidentBase"></div>
                    <div id="accidentCards"></div>
                </section>

                <section id="panel-coverage" class="tab-panel" role="tabpanel" aria-labelledby="tab-coverage">
                    <div id="policyCoverageWrap"></div>
                </section>
                <section id="panel-log" class="tab-panel" role="tabpanel" aria-labelledby="tab-log">
                    <div id="journalWrap"></div>
                </section>
            </div>
        </div>

        <script>
            // ======= 內嵌 sample（不使用 fetch）。實際串接時改由 API 回傳 =======
            const sample = {
                procSerial: "1",
                retCode: "000",
                retMsg: "呼叫成功",
                claimData: [
                    {
                        claimNo: "01078966",
                        clmAccDt: "20201101",
                        clmAccTM: "10",
                        clmRepNm: "林承辦",
                        insuredNm: "被保險某人",
                        issueBrhCD: "27",
                        handleBrhCD: "20",
                        caseSummary: "保車停等紅燈遭後方財車碰撞，其實是個很長的故事，需要很長的內容測試收合功能。",
                        payStat: [{ premiumCls: "TPL", reserveCD: "32", lossOutstanding: "0.00", deductible: "0", lossPaid: "15,000.00", lossInCurr: "15,000.00" }],
                        lossCauseDesc: "13碰撞，傾覆 – 第三人過失",
                        claimant: "陳某人",
                        addInsuredNm: "",
                        limitDriver: "",
                        insuredHomeTel: "",
                        insuredMobile: "0905123456",
                        insuredAddr: "台北市中山區松江路126號",
                        applicantNm: "陳某人",
                        applicantHomeTel: "",
                        applicantMobile: "0905123456",
                        claimState: "1處理中",
                        insEffDt: "20210701",
                        insExpDtexpDt: "20220701",
                        clmRcvDt: "20211122",
                        policyCoverage: [
                            { coverageCD: "B3", coverageDesc: "車體全損免折舊", coverageInsAmtDesc: "賠償最高限額", coverageInsAmt: "249,000", coverageDeduct: "52", coverageInsPrm: "178" },
                            { coverageCD: "C3", coverageDesc: "車體許可使用免追償", coverageInsAmtDesc: "賠償最高限額", coverageInsAmt: "249,000", coverageDeduct: "52", coverageInsPrm: "190" },
                            { coverageCD: "05", coverageDesc: "車對車碰撞車體損失險", coverageInsAmtDesc: "", coverageInsAmt: "249,000", coverageDeduct: "車碰車免自負額", coverageInsPrm: "12,692" },
                            { coverageCD: "31", coverageDesc: "test險", coverageInsAmtDesc: "", coverageInsAmt: "249,000", coverageDeduct: "無", coverageInsPrm: "10,000" },
                        ],
                        policyContents: ["乘客險限單一駕駛者一人", "加保乙型颱風險自負額20%"],
                        accLoc: "15苗栗縣",
                        clmAccLocation: "苗栗縣苗栗市縣府路縣政府前",
                        policeUnit: "苗栗分局",
                        policeNm: "鍾某人",
                        referClaimNo: "66666666",
                        inputTypDesc: "追償件，需轉法務",
                        regNum: "ABC-0001",
                        mtrTyp: "03自用小客車",
                        makeCD: "3003990 ",
                        mtrYR: "2018",
                        driverNm: "陳某人",
                        driverID: "A123456789",
                        driverSex: "男",
                        accLiabilityPcnt: "50(%) 說明：右轉疏忽 ",
                        driverTEL: "",
                        driverMobile: "0905123456",
                        vehicles: [
                            {
                                contRegNum: "XYZ-001",
                                contDriverNm: "許小姐",
                                contDriverID: "F223456789",
                                contDriverSex: "女",
                                contDriverAdrs: "",
                                contAccLibilityPcnt: "50(%) 說明：右轉疏忽 ",
                                contDriverTEL: "",
                                contDriverMobile: "0918123456",
                            },
                        ],
                        nonVehicles: [
                            { pdNonVehicle: "電線桿", pdAccLibilityPcnt: "", ownerNm: "苗栗縣政府", ownerTEL: "" },
                            { pdNonVehicle: "花盆", pdAccLibilityPcnt: "", ownerNm: "苗栗縣政府", ownerTEL: "" },
                        ],
                        victimsV: [
                            { victimDamageTypCD: "", victimAccLibilityPcnt: "", victimNm: "許小姐", victimMobile: "0918123456", victimSex: "女" },
                            { victimDamageTypCD: "", victimAccLibilityPcnt: "", victimNm: "江小姐", victimMobile: "0918654321", victimSex: "女" },
                        ],
                        victimsC: [{ victimDamageTypCD: "", victimAccLibilityPcnt: "", victimNm: "何先生", victimMobile: "0900123456", victimSex: "男" }],
                        journal: [
                            {
                                seqNo: 1,
                                inputDt: "20201101 14:05:32",
                                handleelDt: "20201101",
                                handleelItemCD: "15",
                                handleelItemDesc: "SMS 發送簡訊",
                                contactNm: "陳某人",
                                contentMatters: "XXXXXX",
                                handlerUsrID: "",
                                handlerUsrNm: "",
                                inputUsrID: "",
                                inputUsrNm: "",
                            },
                        ],
                        transLog: [
                            {
                                seqNo: 1,
                                tranNo: "0001",
                                inputDt: "20211122",
                                hostUsrAcnt: "PMA1",
                                hostUsrNm: "李某人",
                                clmRepID: "OP001",
                                clmRepNm: "張某人",
                                tranDesc: "賠案登錄",
                                reasonDesc: "",
                                premiumCls: "TPL",
                                reserveCD: "32",
                                lossPaid: "0.00",
                                revbal: "25,000.00",
                                chgbal: "25,000.00",
                            },
                            {
                                seqNo: 2,
                                TranNo: "0002",
                                inputDt: "20211123",
                                hostUsrAcnt: "PMA1",
                                hostUsrNm: "李某人",
                                clmRepID: "OP001",
                                clmRepNm: "張某人",
                                tranDesc: "賠案修正",
                                reasonDesc: "修改RESERVE",
                                premiumCls: " TPL",
                                reserveCD: "32",
                                lossPaid: "0.00",
                                revbal: "-5,000",
                                chgbal: "10,000",
                            },
                        ],
                    },
                ],
            };

            const data = sample.claimData && sample.claimData.length ? sample.claimData[0] : {};

            // ======= 小工具 =======
            const text = (v) => (v === undefined || v === null || v === "" ? "—" : String(v));
            const yyyymmddToDash = (s) => {
                if (!s) return s;
                const m = String(s).match(/^\d{8}$/);
                if (!m) return s;
                return s.slice(0, 4) + "-" + s.slice(4, 6) + "-" + s.slice(6, 8);
            };
            const hhmmFrom = (s) => {
                if (!s) return s;
                const t = String(s);
                if (t.length === 4) return t.slice(0, 2) + ":" + t.slice(2, 4);
                if (t.length <= 2) return t.padStart(2, "0") + ":00";
                return t;
            };
            const safe = (v) => (v === null || v === undefined || v === "" ? "—" : String(v));

            function el(tag, className, txt) {
                const n = document.createElement(tag);
                if (className) n.className = className;
                if (txt !== undefined) n.textContent = txt;
                return n;
            }

            function makeDivider() {
                return el("hr", "basic-sep");
            }

            function makeKVGrid(pairs) {
                const wrap = el("div", "kv-grid");
                pairs.forEach(([k, v]) => {
                    const row = el("div", "kv-row");
                    row.appendChild(el("div", "kv-key", k));
                    const val = el("div", "kv-val");
                    if (v instanceof HTMLElement) {
                        val.appendChild(v);
                    } else {
                        val.textContent = v;
                    }
                    row.appendChild(val);
                    wrap.appendChild(row);
                });
                return wrap;
            }

            function makeInfoCard(title, pairs) {
                const card = el("section", "info-card");
                const head = el("div", "info-card-head");
                head.appendChild(el("div", "info-card-title", title));
                card.appendChild(head);
                card.appendChild(makeKVGrid(pairs));
                return card;
            }

            function makeCollapsibleCard(title, contentEl, count, defaultOpen = false) {
                const card = el("section", "info-card collapsible");
                const head = el("div", "info-card-head");
                const titleBox = el("div", "info-card-title");
                titleBox.appendChild(el("span", "caret"));
                titleBox.appendChild(el("span", "", title));
                head.appendChild(titleBox);
                const right = el("div");
                if (typeof count === "number") {
                    right.appendChild(el("span", "count-badge", String(count)));
                }
                head.appendChild(right);
                card.appendChild(head);
                const body = contentEl || el("div");
                card.appendChild(body);

                // 初始是否展開
                if (defaultOpen) {
                    card.classList.add("is-open");
                    body.style.display = "";
                } else {
                    body.style.display = "none";
                }

                head.addEventListener("click", () => {
                    const open = card.classList.toggle("is-open");
                    // 重新抓最後一個孩子作為 body，避免後續替換失聯
                    const b = card.lastElementChild;
                    b.style.display = open ? "" : "none";
                });
                return card;
            }

            // 讓字串電話變成可撥號連結
            function telify(val) {
                const p = safe(val);
                if (p === "—") return p;
                const a = document.createElement("a");
                a.href = "tel:" + p.replace(/[^\d+]/g, "");
                a.textContent = p;
                return a;
            }

            // ======= Header（美化渲染） =======
            function renderHeader() {
                const card = document.getElementById("claim-header-card");
                card.innerHTML = "";

                const top = el("div", "head-top");
                const left = el("div");
                left.appendChild(el("div", "muted", "賠案號碼"));
                const strong = el("div", "claim-strong", text(data.claimNo));
                left.appendChild(strong);
                const right = el("div");
                right.appendChild(el("span", "badge badge-processing", text(data.claimState)));
                top.appendChild(left);
                top.appendChild(right);
                card.appendChild(top);

                const kv = el("div", "kv kv-tight");
                const dt = [yyyymmddToDash(data.clmAccDt), hhmmFrom(data.clmAccTM)].filter(Boolean).join(" ");
                const unitCell = el("div");
                const chip1 = el("span", "chip", "出單 " + text(data.issueBrhCD));
                const chip2 = el("span", "chip", "處理 " + text(data.handleBrhCD));
                unitCell.appendChild(chip1);
                unitCell.appendChild(chip2);
                const caseCell = el("div");
                const summary = el("div", "clamp-2", text(data.caseSummary));
                const btn = el("button", "link-sm", "展開");
                let expanded = false;
                btn.addEventListener("click", () => {
                    expanded = !expanded;
                    summary.style.display = expanded ? "block" : "";
                    btn.textContent = expanded ? "收合" : "展開";
                });
                caseCell.appendChild(summary);
                caseCell.appendChild(btn);

                const frag = document.createDocumentFragment();
                [
                    ["出險時間", dt],
                    ["承辦人員", data.clmRepNm],
                    ["單位代號", unitCell],
                    ["被保險人", data.insuredNm],
                    ["案情摘要", caseCell],
                ].forEach(([k, v]) => {
                    frag.appendChild(el("div", "k", k));
                    const vEl = el("div", "v");
                    if (v instanceof HTMLElement) {
                        vEl.appendChild(v);
                    } else {
                        vEl.textContent = text(v);
                    }
                    frag.appendChild(vEl);
                });
                kv.appendChild(frag);
                card.appendChild(kv);
            }

            // ======= 基本資料（保持原樣式） =======
            function renderBasic() {
                const root = document.getElementById("panel-basic");
                root.innerHTML = "";
                root.classList.add("basic-compact");

                const topPairs = [
                    ["收件日期", safe(yyyymmddToDash(data.clmRcvDt))],
                    ["起保日期", safe(yyyymmddToDash(data.insEffDt))],
                    ["到期日期", safe(yyyymmddToDash(data.insExpDtexpDt))],
                    ["出險原因", safe(data.lossCauseDesc)],
                    ["索賠人", safe(data.claimant)],
                ];
                root.appendChild(makeKVGrid(topPairs));
                root.appendChild(makeDivider());

                const bottomPairs = [
                    ["附加被保險人", safe(data.addInsuredNm)],
                    ["限定駕駛人", safe(data.limitDriver)],
                ];
                root.appendChild(makeKVGrid(bottomPairs));

                root.appendChild(
                    makeInfoCard("被保險人資訊", [
                        ["姓名", safe(data.insuredNm)],
                        ["室內電話", safe(data.insuredHomeTel)],
                        ["行動電話", telify(data.insuredMobile)],
                        ["地址", safe(data.insuredAddr)],
                    ])
                );

                root.appendChild(
                    makeInfoCard("要保人資訊", [
                        ["姓名", safe(data.applicantNm)],
                        ["室內電話", safe(data.applicantHomeTel)],
                        ["行動電話", telify(data.applicantMobile)],
                        ["地址", safe(data.applicantAddr)],
                    ])
                );
            }

            // ======= 事故資料（一致風格 + 分隔線 + 5 卡片） =======
            function renderAccident() {
                // 1) 基本欄位 + 分隔線（無框樣式）
                const base = document.getElementById("accidentBase");
                base.innerHTML = "";
                const g1 = makeKVGrid([
                    ["任意/強制險賠案號", safe(data.referClaimNo)],
                    ["出險地點", safe(data.accLoc)],
                    ["出險詳細位置", safe(data.clmAccLocation)],
                    ["案件類型", safe(data.inputTypDesc)],
                ]);
                g1.classList.add("kv-plain");
                base.appendChild(g1);
                base.appendChild(makeDivider());
                const g2 = makeKVGrid([
                    ["警方單位", safe(data.policeUnit)],
                    ["警員姓名", safe(data.policeNm)],
                ]);
                g2.classList.add("kv-plain");
                base.appendChild(g2);

                // 2) 保車資訊（預設收合）
                const cards = document.getElementById("accidentCards");
                cards.innerHTML = "";
                const insuredCarGrid = makeKVGrid([
                    ["車號", safe(data.regNum)],
                    ["車輛種類", safe(data.mtrTyp)],
                    ["廠牌車型", safe(data.makeCD)],
                    ["製造年份", safe(data.mtrYR)],
                    ["駕駛人姓名", safe(data.driverNm)],
                    ["駕駛人ID", safe(data.driverID)],
                    ["駕駛人性別", safe(data.driverSex)],
                    ["肇責比例", safe(data.accLiabilityPcnt)],
                    ["室內電話", safe(data.driverTEL)],
                    ["行動電話", telify(data.driverMobile)],
                ]);
                insuredCarGrid.classList.add("kv-plain"); // ← 新增這行
                cards.appendChild(makeCollapsibleCard("保車資訊", insuredCarGrid, undefined, false));

                // 3) 財車資料（多筆，預設收合；粗體標題 + 無框欄位 + 分隔線）
                const vehicles = Array.isArray(data.vehicles) ? data.vehicles : [];
                const vList = el("div", "sub-collection");
                vehicles.forEach((v, i) => {
                    vList.appendChild(el("div", "item-title", `財車 ${i + 1}`));
                    const grid = makeKVGrid([
                        ["車號", safe(v.contRegNum)],
                        ["駕駛人姓名", safe(v.contDriverNm)],
                        ["駕駛人ID", safe(v.contDriverID)],
                        ["駕駛人性別", safe(v.contDriverSex)],
                        ["駕駛人地址", safe(v.contDriverAdrs)],
                        ["肇責比例", safe(v.contAccLibilityPcnt)],
                        ["室內電話", safe(v.contDriverTEL)],
                        ["行動電話", telify(v.contDriverMobile)],
                    ]);
                    grid.classList.add("kv-plain");
                    vList.appendChild(grid);
                    if (i < vehicles.length - 1) vList.appendChild(el("hr", "sub-divider"));
                });
                cards.appendChild(makeCollapsibleCard("財車資料", vList, vehicles.length, false));

                // 4) 非財車資料
                const nonV = Array.isArray(data.nonVehicles) ? data.nonVehicles : [];
                const nList = el("div", "sub-collection");
                nonV.forEach((nv, i) => {
                    nList.appendChild(el("div", "item-title", `非財車 ${i + 1}`));
                    const grid = makeKVGrid([
                        ["非車輛財損", safe(nv.pdNonVehicle)],
                        ["肇責比例", safe(nv.pdAccLibilityPcnt)],
                        ["物主姓名", safe(nv.ownerNm)],
                        ["物主電話", safe(nv.ownerTEL)],
                    ]);
                    grid.classList.add("kv-plain");
                    nList.appendChild(grid);
                    if (i < nonV.length - 1) nList.appendChild(el("hr", "sub-divider"));
                });
                cards.appendChild(makeCollapsibleCard("非財車資料", nList, nonV.length, false));

                // 5) 受害人-任意
                const vV = Array.isArray(data.victimsV) ? data.victimsV : [];
                const vVList = el("div", "sub-collection");
                vV.forEach((vv, i) => {
                    vVList.appendChild(el("div", "item-title", `受害人(任意) ${i + 1}`));
                    const grid = makeKVGrid([
                        ["傷情代號", safe(vv.victimDamageTypCD)],
                        ["肇責比例", safe(vv.victimAccLibilityPcnt)],
                        ["姓名", safe(vv.victimNm)],
                        ["行動電話", telify(vv.victimMobile)],
                        ["性別", safe(vv.victimSex)],
                    ]);
                    grid.classList.add("kv-plain");
                    vVList.appendChild(grid);
                    if (i < vV.length - 1) vVList.appendChild(el("hr", "sub-divider"));
                });
                cards.appendChild(makeCollapsibleCard("受害人-任意", vVList, vV.length, false));

                // 6) 受害人-強制
                const vC = Array.isArray(data.victimsC) ? data.victimsC : [];
                const vCList = el("div", "sub-collection");
                vC.forEach((vc, i) => {
                    vCList.appendChild(el("div", "item-title", `受害人(強制) ${i + 1}`));
                    const grid = makeKVGrid([
                        ["傷情代號", safe(vc.victimDamageTypCD)],
                        ["肇責比例", safe(vc.victimAccLibilityPcnt)],
                        ["姓名", safe(vc.victimNm)],
                        ["行動電話", telify(vc.victimMobile)],
                        ["性別", safe(vc.victimSex)],
                    ]);
                    grid.classList.add("kv-plain");
                    vCList.appendChild(grid);
                    if (i < vC.length - 1) vCList.appendChild(el("hr", "sub-divider"));
                });
                cards.appendChild(makeCollapsibleCard("受害人-強制", vCList, vC.length, false));
            }

            // ======= 承保內容 =======
            function renderCoverage() {
                const wrap = document.getElementById("policyCoverageWrap");
                wrap.innerHTML = "";
                const arr = Array.isArray(data.policyCoverage) ? data.policyCoverage : [];
                if (!arr.length) {
                    wrap.textContent = "—";
                    return;
                }
                arr.forEach((p, i) => {
                    const box = el("div", "sub-card");
                    box.appendChild(el("div", "sub-title", `承保項目 ${i + 1}`));
                    const kv = el("div", "kv");
                    const frag = document.createDocumentFragment();
                    [
                        ["險種", p.coverageCD],
                        ["保險種類", p.coverageDesc],
                        ["給付項目", p.coverageInsAmtDesc],
                        ["保險金額", p.coverageInsAmt],
                        ["自負額", p.coverageDeduct],
                        ["保險費", p.coverageInsPrm],
                    ].forEach(([k, v]) => {
                        frag.appendChild(el("div", "k", k));
                        frag.appendChild(el("div", "v", text(v)));
                    });
                    kv.appendChild(frag);
                    box.appendChild(kv);
                    wrap.appendChild(box);
                });
            }

            // ======= 日誌 =======
            function renderJournal() {
                const wrap = document.getElementById("journalWrap");
                wrap.innerHTML = "";
                const arr = Array.isArray(data.journal) ? data.journal : [];
                if (!arr.length) {
                    wrap.textContent = "—";
                    return;
                }
                arr.forEach((j) => {
                    const box = el("div", "sub-card");
                    box.appendChild(el("div", "sub-title", `日誌序號 ${j.seqNo ?? ""}`));
                    const kv = el("div", "kv");
                    const handleDt = j.handleDt || j.handleelDt;
                    const handleItemCD = j.handleItemCD || j.handleelItemCD;
                    const handleItemDesc = j.handleItemDesc || j.handleelItemDesc;
                    const frag = document.createDocumentFragment();
                    [
                        ["輸入日期", j.inputDt],
                        ["處理日期", handleDt],
                        ["處理項目代號", handleItemCD],
                        ["處理項目名稱", handleItemDesc],
                        ["聯絡人員姓名", j.contactNm],
                        ["處理內容", j.contentMatters],
                        ["處理人員代號", j.handlerUsrID],
                        ["處理人員姓名", j.handlerUsrNm],
                        ["輸入人員代號", j.inputUsrID],
                        ["輸入人員姓名", j.inputUsrNm],
                    ].forEach(([k, v]) => {
                        frag.appendChild(el("div", "k", k));
                        frag.appendChild(el("div", "v", text(v)));
                    });
                    kv.appendChild(frag);
                    box.appendChild(kv);
                    wrap.appendChild(box);
                });
            }

            // ======= Tab 切換 =======
            function initTabs() {
                const tabBtns = document.querySelectorAll(".tab-btn");
                const panels = document.querySelectorAll(".tab-panel");
                tabBtns.forEach((btn) => {
                    btn.addEventListener("click", () => {
                        tabBtns.forEach((b) => b.setAttribute("aria-selected", String(b === btn)));
                        panels.forEach((p) => p.classList.remove("active"));
                        const pid = btn.getAttribute("aria-controls");
                        document.getElementById(pid).classList.add("active");
                    });
                });
            }

            // ======= 進場 =======
            document.addEventListener("DOMContentLoaded", () => {
                renderHeader();
                renderBasic();
                renderAccident();
                renderCoverage();
                renderJournal();
                initTabs();
            });
        </script>
    </body>
</html>
