<!DOCTYPE html>
<html lang="zh-Hant">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>行動任務處理 - 資料補傳 - 賠案明細</title>
        <style>
            *,
            *::before,
            *::after {
                box-sizing: border-box;
            }
            :root {
                --bg: #f5f6f8;
                --card: #fff;
                --text: #111827;
                --muted: #6b7280;
                --line: #e5e7eb;
                --brand: #2563eb;
                --muted-bg: #f3f4f6;
                --radius: 10px;
                --r-sm: 8px;
                --shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
                --fs-xxs: 0.78rem;
                --fs-xs: 0.86rem;
                --fs-sm: 0.92rem;
                --fs-md: 1rem;
                --fs-lg: 1.125rem;
                --fs-xl: 1.25rem;
                --gap-1: 6px;
                --gap-2: 10px;
                --gap-3: 14px;
                --gap-4: 16px;
                --gap-5: 20px;
                --keyw: 140px;
                --keyw-m: 110px;
            }
            html,
            body {
                height: 100%;
            }
            body {
                font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans TC", "PingFang TC", sans-serif;
                margin: 0;
                padding: 20px;
                background: var(--bg);
                color: var(--text);
            }
            h2 {
                margin: 0 0 12px;
                display: flex;
                align-items: center;
                gap: 10px;
                font-size: var(--fs-lg);
            }
            .card {
                background: var(--card);
                padding: 18px;
                border-radius: var(--radius);
                box-shadow: var(--shadow);
                margin: 0 auto 16px;
                max-width: 1000px;
            }
            .btn-row {
                display: flex;
                justify-content: center;
                gap: 10px;
                flex-wrap: wrap;
                margin: 18px auto;
                max-width: 1000px;
            }
            .btn {
                padding: 10px 16px;
                border: none;
                border-radius: 8px;
                font-size: var(--fs-md);
                color: #fff;
                cursor: pointer;
            }
            .btn-primary {
                background: var(--brand);
            }
            .tab-card {
                padding: 0;
            }
            .tab-nav {
                display: flex;
                gap: 6px;
                overflow-x: auto;
                white-space: nowrap;
                border-bottom: 1px solid var(--line);
                padding: 10px;
                border-top-left-radius: var(--radius);
                border-top-right-radius: var(--radius);
                background: var(--card);
            }
            .tab-btn {
                border: none;
                background: var(--muted-bg);
                color: #111;
                padding: 8px 14px;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
            }
            .tab-btn[aria-selected="true"] {
                background: #fff;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
            }
            .tab-panels {
                padding: 16px 20px 20px;
            }
            .tab-panel {
                display: none;
            }
            .tab-panel.active {
                display: block;
            }
            .kv {
                display: grid;
                grid-template-columns: var(--keyw) 1fr;
                gap: 8px 16px;
            }
            .k {
                color: var(--muted);
                font-size: var(--fs-sm);
                text-align: right;
            }
            .v {
                font-size: var(--fs-md);
            }
            .sub-card {
                border: 1px solid var(--line);
                border-radius: var(--r-sm);
                padding: 12px 14px;
                margin: 10px 0;
                background: #fafafa;
            }
            .sub-title {
                font-weight: 700;
                margin: 4px 0 12px;
            }
            .head {
                padding: 16px 18px;
            }
            .head-top {
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 10px;
                margin-bottom: 8px;
            }
            .claim-strong {
                font-size: var(--fs-xl);
                font-weight: 800;
                letter-spacing: 0.5px;
            }
            .muted {
                color: var(--muted);
            }
            .chip {
                display: inline-block;
                padding: 2px 8px;
                border-radius: 999px;
                background: var(--muted-bg);
                font-size: var(--fs-xs);
                margin-right: 6px;
            }
            .badge {
                display: inline-block;
                padding: 2px 10px;
                border-radius: 999px;
                font-size: var(--fs-xs);
                border: 1px solid var(--line);
            }
            .badge-processing {
                background: #fff7ed;
                color: #9a3412;
                border-color: #fed7aa;
            }
            .badge-done {
                background: #ecfdf5;
                color: #065f46;
                border-color: #a7f3d0;
            }
            .clamp-2 {
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
                overflow: hidden;
            }
            .link-sm {
                font-size: var(--fs-xs);
                margin-left: 8px;
                background: none;
                border: none;
                color: var(--brand);
                cursor: pointer;
            }
            .kv.kv-tight {
                gap: 6px 14px;
            }
            @media (max-width: 767px) {
                body {
                    padding: 16px;
                }
                .kv {
                    grid-template-columns: var(--keyw-m) 1fr;
                }
                .k {
                    text-align: left;
                }
                .btn {
                    width: 100%;
                }
                .chip {
                    margin-bottom: 6px;
                }
                .head-top {
                    align-items: flex-start;
                }
                .tab-btn {
                    font-size: 1.05rem;
                    padding: 10px 10px;
                    min-height: 36px;
                    line-height: 1.4;
                }
            }
            .basic-sep {
                border: 0;
                border-top: 1px dashed #d8dbe0;
                margin: 14px 0 18px;
            }
            .kv-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px 18px;
                margin-bottom: 12px;
            }
            .kv-row {
                display: grid;
                grid-template-columns: 120px 1fr;
                align-items: center;
                min-height: 32px;
                background: #fff;
                padding: 6px 10px;
                border: 1px solid #eef0f3;
                border-radius: 8px;
            }
            .kv-key {
                color: #6b7280;
                font-size: 0.92rem;
            }
            .kv-val {
                font-weight: 600;
                word-break: break-all;
            }
            .info-card {
                border: 1px solid #e6e9ef;
                border-radius: 12px;
                background: #fafbfc;
                margin: 14px 0 8px;
                overflow: hidden;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
            }
            .info-card-head {
                padding: 10px 12px;
                background: #f3f5f8;
                border-bottom: 1px solid #e6e9ef;
                display: flex;
                align-items: center;
                justify-content: space-between;
                cursor: default;
            }
            .info-card-title {
                font-weight: 700;
                font-size: 1rem;
                letter-spacing: 0.02em;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            .info-card .kv-grid {
                padding: 12px;
                margin-bottom: 0;
            }
            .collapsible {
                overflow: hidden;
            }
            .collapsible .info-card-head {
                cursor: pointer;
            }
            .caret {
                width: 0;
                height: 0;
                border-left: 6px solid transparent;
                border-right: 6px solid transparent;
                border-top: 6px solid #6b7280;
                transform: rotate(-90deg);
                transition: transform 0.18s ease;
            }
            .is-open .caret {
                transform: rotate(0deg);
            }
            .count-badge {
                font-size: 0.86rem;
                color: #374151;
                background: #eef2f7;
                border: 1px solid #e2e8f0;
                padding: 2px 8px;
                border-radius: 999px;
            }
            .sub-collection {
                padding: 10px 12px;
            }
            .item-title {
                font-weight: 800;
                font-size: 1.02rem;
                padding: 2px 0 6px;
            }
            .sub-divider {
                border: 0;
                border-top: 1px dashed #e3e7ee;
                margin: 10px 0;
            }
            .kv-plain .kv-row {
                background: transparent;
                border: 0;
                border-radius: 0;
                padding: 2px 0;
            }
            .kv-plain .kv-row + .kv-row {
                border-top: 1px dotted #eceff3;
                padding-top: 6px;
                margin-top: 6px;
            }
            @media (max-width: 767px) {
                .kv-grid {
                    grid-template-columns: 1fr;
                    gap: 8px;
                }
                .kv-row {
                    grid-template-columns: 90px 1fr;
                    min-height: 38px;
                    padding: 8px 10px;
                }
                .info-card-title {
                    font-size: 0.98rem;
                }
            }
            #panel-basic.basic-compact .kv-grid {
                gap: 6px 16px;
                margin-bottom: 10px;
            }
            #panel-basic.basic-compact .kv-row {
                background: transparent;
                border: 0;
                border-radius: 0;
                padding: 2px 0;
                min-height: unset;
                display: grid;
                grid-template-columns: 92px 1fr;
            }
            #panel-basic.basic-compact .kv-row + .kv-row {
                border-top: 1px dotted #eceff3;
                padding-top: 6px;
                margin-top: 6px;
            }
            #panel-basic.basic-compact .kv-key {
                color: #8a94a3;
                font-weight: 500;
                font-size: 0.92rem;
            }
            #panel-basic.basic-compact .kv-val {
                font-weight: 600;
                word-break: break-word;
            }
            #panel-basic.basic-compact .info-card {
                border: 1px solid #e6e9ef;
                background: #f7f9fb;
                margin: 12px 0 10px;
                border-radius: 12px;
            }
            #panel-basic.basic-compact .info-card .kv-grid {
                padding: 10px 12px;
            }
            #panel-basic.basic-compact .info-card .kv-row {
                background: transparent;
                border: 0;
                border-radius: 0;
                padding: 2px 0;
                grid-template-columns: 72px 1fr;
            }
            #panel-basic.basic-compact .info-card .kv-row + .kv-row {
                border-top: 1px dotted #e9edf2;
                padding-top: 6px;
                margin-top: 6px;
            }
            @media (max-width: 767px) {
                #panel-basic.basic-compact .kv-grid {
                    grid-template-columns: 1fr;
                    gap: 6px;
                }
                #panel-basic.basic-compact .kv-row {
                    grid-template-columns: 88px 1fr;
                    padding: 4px 0;
                }
                #panel-basic.basic-compact .info-card .kv-row {
                    grid-template-columns: 68px 1fr;
                }
            }
            /* 承保內容 */
            .coverage-total {
                font-weight: 800;
                font-size: 1.05rem;
                margin: 4px 0 12px;
            }
            .kv.kv-two {
                grid-template-columns: var(--keyw) 1fr var(--keyw) 1fr;
                gap: 8px 18px;
            }
            @media (max-width: 767px) {
                .kv.kv-two {
                    grid-template-columns: var(--keyw-m) 1fr;
                }
            }
            .plain-list {
                margin: 6px 0 0 0;
                padding-left: 1.1em;
            }
            .plain-list li {
                margin: 6px 0;
            }
            /* 日誌：工具列與時間線 */
            .toolbar {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                align-items: center;
                margin-bottom: 8px;
            }
            .chip {
                display: inline-block;
                padding: 4px 10px;
                border-radius: 999px;
                background: var(--muted-bg);
                font-size: var(--fs-xs);
                border: 1px solid var(--line);
                cursor: pointer;
                user-select: none;
            }
            .chip.active {
                background: #eaf1ff;
                color: #1d4ed8;
                border-color: #c7d2fe;
            }
            .search-toggle {
                font-size: 0.9rem;
                color: #1d4ed8;
                background: none;
                border: none;
                cursor: pointer;
                padding: 4px 8px;
            }
            .search-box {
                display: none;
                margin: 6px 0 10px;
                width: min(100%, 26rem);
            }
            .search-box.open {
                display: block;
            }
            .search-box input {
                width: 100%;
                padding: 8px 10px;
                border: 1px solid #e5e7eb;
                border-radius: 8px;
                font-size: 1rem;
            }
            .bar-actions {
                margin-left: auto;
                display: flex;
                gap: 8px;
            }
            .link-xs {
                font-size: 0.86rem;
                color: #1d4ed8;
                background: none;
                border: none;
                cursor: pointer;
            }
            .select-wrap {
                width: min(100%, 30rem);
            }
            .select-wrap select {
                width: 100%;
                padding: 8px 10px;
                border: 1px solid #e5e7eb;
                border-radius: 8px;
                background: #fff;
                font-size: 1rem;
            }
            .timeline {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }
            .t-item {
                display: grid;
                grid-template-columns: 120px 1fr;
                gap: 12px;
                align-items: start;
            }
            .t-time {
                color: var(--muted);
                font-size: 0.9rem;
            }
            .t-card {
                position: relative;
                border: 1px solid #e6e9ef;
                background: #fafbfc;
                border-radius: 12px;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
                overflow: hidden;
            }
            .t-head {
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 10px;
                padding: 10px 12px;
                border-bottom: 1px solid #e6e9ef;
                background: #f3f5f8;
            }
            .t-title {
                font-weight: 700;
            }
            .badge-src {
                border: 1px solid #e5e7eb;
                border-radius: 999px;
                padding: 2px 8px;
                font-size: 0.78rem;
            }
            .badge-src.manual {
                background: #ecfdf5;
                color: #065f46;
                border-color: #a7f3d0;
            }
            .badge-src.system {
                background: #fef3c7;
                color: #92400e;
                border-color: #fcd34d;
            }
            .t-body {
                padding: 10px 12px;
                background: #fff;
            }
            @media (max-width: 767px) {
                .t-item {
                    grid-template-columns: 1fr;
                }
            }
        </style>
    </head>
    <body>
        <h2>賠案明細</h2>
        <div class="card head" id="claim-header-card"></div>
        <div class="btn-row">
            <button class="btn btn-primary" onclick="location.href='03.claim_log_upload.html'">日誌新增</button>
            <button class="btn btn-primary" onclick="location.href='03.claim_file_upload.html'">檔案上傳</button>
        </div>
        <div class="card tab-card">
            <div class="tab-nav">
                <button class="tab-btn" role="tab" aria-selected="true" aria-controls="panel-basic" id="tab-basic">基本資料</button>
                <button class="tab-btn" role="tab" aria-selected="false" aria-controls="panel-accident" id="tab-accident">事故資料</button>
                <button class="tab-btn" role="tab" aria-selected="false" aria-controls="panel-coverage" id="tab-coverage">承保內容</button>
                <button class="tab-btn" role="tab" aria-selected="false" aria-controls="panel-log" id="tab-log">日誌</button>
            </div>
            <div class="tab-panels">
                <section id="panel-basic" class="tab-panel active" role="tabpanel" aria-labelledby="tab-basic">
                    <div class="kv" id="basicKV"></div>
                </section>
                <section id="panel-accident" class="tab-panel" role="tabpanel" aria-labelledby="tab-accident">
                    <div id="accidentBase"></div>
                    <div id="accidentCards"></div>
                </section>
                <section id="panel-coverage" class="tab-panel" role="tabpanel" aria-labelledby="tab-coverage">
                    <div id="policyCoverageWrap"></div>
                </section>
                <section id="panel-log" class="tab-panel" role="tabpanel" aria-labelledby="tab-log">
                    <div id="journalWrap"></div>
                </section>
            </div>
        </div>

        <script>
            // ===== sample data =====
            const sample = {
                procSerial: "1",
                retCode: "000",
                retMsg: "呼叫成功",
                claimData: [
                    {
                        claimNo: "01078966",
                        clmAccDt: "20201101",
                        clmAccTM: "10",
                        clmRepNm: "林承辦",
                        insuredNm: "被保險某人",
                        issueBrhCD: "27",
                        handleBrhCD: "20",
                        caseSummary: "保車停等紅燈遭後方財車碰撞，其實是個很長的故事，需要很長的內容測試收合功能。",
                        payStat: [{ premiumCls: "TPL", reserveCD: "32", lossOutstanding: "0.00", deductible: "0", lossPaid: "15,000.00", lossInCurr: "15,000.00" }],
                        lossCauseDesc: "13碰撞，傾覆 – 第三人過失",
                        claimant: "陳某人",
                        addInsuredNm: "",
                        limitDriver: "",
                        insuredHomeTel: "",
                        insuredMobile: "0905123456",
                        insuredAddr: "台北市中山區松江路126號",
                        applicantNm: "陳某人",
                        applicantHomeTel: "",
                        applicantMobile: "0905123456",
                        claimState: "1處理中",
                        insEffDt: "20210701",
                        insExpDtexpDt: "20220701",
                        clmRcvDt: "20211122",
                        policyCoverage: [
                            { coverageCD: "B3", coverageDesc: "車體全損免折舊", coverageInsAmtDesc: "賠償最高限額", coverageInsAmt: "249,000", coverageDeduct: "52", coverageInsPrm: "178" },
                            { coverageCD: "C3", coverageDesc: "車體許可使用免追償", coverageInsAmtDesc: "賠償最高限額", coverageInsAmt: "249,000", coverageDeduct: "52", coverageInsPrm: "190" },
                            { coverageCD: "05", coverageDesc: "車對車碰撞車體損失險", coverageInsAmtDesc: "", coverageInsAmt: "249,000", coverageDeduct: "車碰車免自負額", coverageInsPrm: "12,692" },
                            { coverageCD: "31", coverageDesc: "test險", coverageInsAmtDesc: "", coverageInsAmt: "249,000", coverageDeduct: "無", coverageInsPrm: "10,000" },
                        ],
                        policyContents: ["乘客險限單一駕駛者一人", "加保乙型颱風險自負額20%"],
                        accLoc: "15苗栗縣",
                        clmAccLocation: "苗栗縣苗栗市縣府路縣政府前",
                        policeUnit: "苗栗分局",
                        policeNm: "鍾某人",
                        referClaimNo: "66666666",
                        inputTypDesc: "追償件，需轉法務",
                        regNum: "ABC-0001",
                        mtrTyp: "03自用小客車",
                        makeCD: "3003990 ",
                        mtrYR: "2018",
                        driverNm: "陳某人",
                        driverID: "A123456789",
                        driverSex: "男",
                        accLiabilityPcnt: "50(%) 說明：右轉疏忽 ",
                        driverTEL: "",
                        driverMobile: "0905123456",
                        vehicles: [
                            {
                                contRegNum: "XYZ-001",
                                contDriverNm: "許小姐",
                                contDriverID: "F223456789",
                                contDriverSex: "女",
                                contDriverAdrs: "",
                                contAccLibilityPcnt: "50(%) 說明：右轉疏忽 ",
                                contDriverTEL: "",
                                contDriverMobile: "0918123456",
                            },
                        ],
                        nonVehicles: [
                            { pdNonVehicle: "電線桿", pdAccLibilityPcnt: "", ownerNm: "苗栗縣政府", ownerTEL: "" },
                            { pdNonVehicle: "花盆", pdAccLibilityPcnt: "", ownerNm: "苗栗縣政府", ownerTEL: "" },
                        ],
                        victimsV: [
                            { victimDamageTypCD: "", victimAccLibilityPcnt: "", victimNm: "許小姐", victimMobile: "0918123456", victimSex: "女" },
                            { victimDamageTypCD: "", victimAccLibilityPcnt: "", victimNm: "江小姐", victimMobile: "0918654321", victimSex: "女" },
                        ],
                        victimsC: [{ victimDamageTypCD: "", victimAccLibilityPcnt: "", victimNm: "何先生", victimMobile: "0900123456", victimSex: "男" }],
                        journal: [
                            {
                                seqNo: 1,
                                inputDt: "20201101 14:05:32",
                                handleelDt: "20201101",
                                handleelItemCD: "15",
                                handleelItemDesc: "SMS 發送簡訊",
                                contactNm: "陳某人",
                                contentMatters: "XXXXXX",
                                handlerUsrID: "",
                                handlerUsrNm: "",
                                inputUsrID: "",
                                inputUsrNm: "",
                            },
                        ],
                        transLog: [
                            {
                                seqNo: 1,
                                tranNo: "0001",
                                inputDt: "20211122",
                                hostUsrAcnt: "PMA1",
                                hostUsrNm: "李某人",
                                clmRepID: "OP001",
                                clmRepNm: "張某人",
                                tranDesc: "賠案登錄",
                                reasonDesc: "",
                                premiumCls: "TPL",
                                reserveCD: "32",
                                lossPaid: "0.00",
                                revbal: "25,000.00",
                                chgbal: "25,000.00",
                            },
                            {
                                seqNo: 2,
                                TranNo: "0002",
                                inputDt: "20211123",
                                hostUsrAcnt: "PMA1",
                                hostUsrNm: "李某人",
                                clmRepID: "OP001",
                                clmRepNm: "張某人",
                                tranDesc: "賠案修正",
                                reasonDesc: "修改RESERVE",
                                premiumCls: " TPL",
                                reserveCD: "32",
                                lossPaid: "0.00",
                                revbal: "-5,000",
                                chgbal: "10,000",
                            },
                        ],
                    },
                ],
            };
            const data = sample.claimData && sample.claimData.length ? sample.claimData[0] : {};

            const text = (v) => (v === undefined || v === null || v === "" ? "—" : String(v));
            const yyyymmddToDash = (s) => {
                if (!s) return s;
                const m = String(s).match(/^\d{8}$/);
                if (!m) return s;
                return s.slice(0, 4) + "-" + s.slice(4, 6) + "-" + s.slice(6, 8);
            };
            const hhmmFrom = (s) => {
                if (!s) return s;
                const t = String(s);
                if (t.length === 4) return t.slice(0, 2) + ":" + t.slice(2, 4);
                if (t.length <= 2) return t.padStart(2, "0") + ":00";
                return t;
            };
            const safe = (v) => (v === null || v === undefined || v === "" ? "—" : String(v));

            function el(tag, className, txt) {
                const n = document.createElement(tag);
                if (className) n.className = className;
                if (txt !== undefined) n.textContent = txt;
                return n;
            }
            function makeDivider() {
                return el("hr", "basic-sep");
            }
            function makeKVGrid(pairs) {
                const wrap = el("div", "kv-grid");
                pairs.forEach(([k, v]) => {
                    const row = el("div", "kv-row");
                    row.appendChild(el("div", "kv-key", k));
                    const val = el("div", "kv-val");
                    if (v instanceof HTMLElement) {
                        val.appendChild(v);
                    } else {
                        val.textContent = v;
                    }
                    row.appendChild(val);
                    wrap.appendChild(row);
                });
                return wrap;
            }
            function makeInfoCard(title, pairs) {
                const card = el("section", "info-card");
                const head = el("div", "info-card-head");
                head.appendChild(el("div", "info-card-title", title));
                card.appendChild(head);
                card.appendChild(makeKVGrid(pairs));
                return card;
            }
            function makeCollapsibleCard(title, contentEl, count, defaultOpen = false) {
                const card = el("section", "info-card collapsible");
                const head = el("div", "info-card-head");
                const titleBox = el("div", "info-card-title");
                titleBox.appendChild(el("span", "caret"));
                titleBox.appendChild(el("span", "", title));
                head.appendChild(titleBox);
                const right = el("div");
                if (typeof count === "number") {
                    right.appendChild(el("span", "count-badge", String(count)));
                }
                head.appendChild(right);
                card.appendChild(head);
                const body = contentEl || el("div");
                card.appendChild(body);
                if (defaultOpen) {
                    card.classList.add("is-open");
                    body.style.display = "";
                } else {
                    body.style.display = "none";
                }
                head.addEventListener("click", () => {
                    const open = card.classList.toggle("is-open");
                    card.lastElementChild.style.display = open ? "" : "none";
                });
                return card;
            }
            const moneyToNumber = (s) => {
                if (s == null) return 0;
                const n = Number(String(s).replace(/[^0-9.-]/g, ""));
                return Number.isFinite(n) ? n : 0;
            };
            const fmtTW = (n) => Number(n || 0).toLocaleString("zh-TW");
            function telify(val) {
                const p = safe(val);
                if (p === "—") return p;
                const a = document.createElement("a");
                a.href = "tel:" + p.replace(/[^\d+]/g, "");
                a.textContent = p;
                return a;
            }

            // ======= 上半部 =======
            function renderHeader() {
                const card = document.getElementById("claim-header-card");
                card.innerHTML = "";
                const top = el("div", "head-top");
                const left = el("div");
                left.appendChild(el("div", "muted", "賠案號碼"));
                const strong = el("div", "claim-strong", text(data.claimNo));
                left.appendChild(strong);
                const right = el("div");
                right.appendChild(el("span", "badge badge-processing", text(data.claimState)));
                top.appendChild(left);
                top.appendChild(right);
                card.appendChild(top);
                const kv = el("div", "kv kv-tight");
                const dt = [yyyymmddToDash(data.clmAccDt), hhmmFrom(data.clmAccTM)].filter(Boolean).join(" ");
                const unitCell = el("div");
                const chip1 = el("span", "chip", "出單 " + text(data.issueBrhCD));
                const chip2 = el("span", "chip", "處理 " + text(data.handleBrhCD));
                unitCell.appendChild(chip1);
                unitCell.appendChild(chip2);
                const caseCell = el("div");
                const summary = el("div", "clamp-2", text(data.caseSummary));
                const btn = el("button", "link-sm", "展開");
                let expanded = false;
                btn.addEventListener("click", () => {
                    expanded = !expanded;
                    summary.style.display = expanded ? "block" : "";
                    btn.textContent = expanded ? "收合" : "展開";
                });
                caseCell.appendChild(summary);
                caseCell.appendChild(btn);
                const frag = document.createDocumentFragment();
                [
                    ["出險時間", dt],
                    ["承辦人員", data.clmRepNm],
                    ["單位代號", unitCell],
                    ["被保險人", data.insuredNm],
                    ["案情摘要", caseCell],
                ].forEach(([k, v]) => {
                    frag.appendChild(el("div", "k", k));
                    const vEl = el("div", "v");
                    if (v instanceof HTMLElement) {
                        vEl.appendChild(v);
                    } else {
                        vEl.textContent = text(v);
                    }
                    frag.appendChild(vEl);
                });
                kv.appendChild(frag);
                card.appendChild(kv);
            }

            // ======= 頁籤:基本資料 =======
            function renderBasic() {
                const root = document.getElementById("panel-basic");
                root.innerHTML = "";
                root.classList.add("basic-compact");
                const topPairs = [
                    ["收件日期", safe(yyyymmddToDash(data.clmRcvDt))],
                    ["起保日期", safe(yyyymmddToDash(data.insEffDt))],
                    ["到期日期", safe(yyyymmddToDash(data.insExpDtexpDt))],
                    ["出險原因", safe(data.lossCauseDesc)],
                    ["索賠人", safe(data.claimant)],
                ];
                root.appendChild(makeKVGrid(topPairs));
                root.appendChild(makeDivider());
                const bottomPairs = [
                    ["附加被保險人", safe(data.addInsuredNm)],
                    ["限定駕駛人", safe(data.limitDriver)],
                ];
                root.appendChild(makeKVGrid(bottomPairs));
                root.appendChild(
                    makeInfoCard("被保險人資訊", [
                        ["姓名", safe(data.insuredNm)],
                        ["室內電話", safe(data.insuredHomeTel)],
                        ["行動電話", telify(data.insuredMobile)],
                        ["地址", safe(data.insuredAddr)],
                    ])
                );
                root.appendChild(
                    makeInfoCard("要保人資訊", [
                        ["姓名", safe(data.applicantNm)],
                        ["室內電話", safe(data.applicantHomeTel)],
                        ["行動電話", telify(data.applicantMobile)],
                        ["地址", safe(data.applicantAddr)],
                    ])
                );
            }

            // ======= 頁籤:事故資料 =======
            function renderAccident() {
                const base = document.getElementById("accidentBase");
                base.innerHTML = "";
                const g1 = makeKVGrid([
                    ["任意/強制險賠案號", safe(data.referClaimNo)],
                    ["出險地點", safe(data.accLoc)],
                    ["出險詳細位置", safe(data.clmAccLocation)],
                    ["案件類型", safe(data.inputTypDesc)],
                ]);
                g1.classList.add("kv-plain");
                base.appendChild(g1);
                base.appendChild(makeDivider());
                const g2 = makeKVGrid([
                    ["警方單位", safe(data.policeUnit)],
                    ["警員姓名", safe(data.policeNm)],
                ]);
                g2.classList.add("kv-plain");
                base.appendChild(g2);
                const cards = document.getElementById("accidentCards");
                cards.innerHTML = "";
                const insuredCarGrid = makeKVGrid([
                    ["車號", safe(data.regNum)],
                    ["車輛種類", safe(data.mtrTyp)],
                    ["廠牌車型", safe(data.makeCD)],
                    ["製造年份", safe(data.mtrYR)],
                    ["駕駛人姓名", safe(data.driverNm)],
                    ["駕駛人ID", safe(data.driverID)],
                    ["駕駛人性別", safe(data.driverSex)],
                    ["肇責比例", safe(data.accLiabilityPcnt)],
                    ["室內電話", safe(data.driverTEL)],
                    ["行動電話", telify(data.driverMobile)],
                ]);
                insuredCarGrid.classList.add("kv-plain");
                cards.appendChild(makeCollapsibleCard("保車資訊", insuredCarGrid, undefined, false));
                const vehicles = Array.isArray(data.vehicles) ? data.vehicles : [];
                const vList = el("div", "sub-collection");
                vehicles.forEach((v, i) => {
                    vList.appendChild(el("div", "item-title", `財車 ${i + 1}`));
                    const grid = makeKVGrid([
                        ["車號", safe(v.contRegNum)],
                        ["駕駛人姓名", safe(v.contDriverNm)],
                        ["駕駛人ID", safe(v.contDriverID)],
                        ["駕駛人性別", safe(v.contDriverSex)],
                        ["駕駛人地址", safe(v.contDriverAdrs)],
                        ["肇責比例", safe(v.contAccLibilityPcnt)],
                        ["室內電話", safe(v.contDriverTEL)],
                        ["行動電話", telify(v.contDriverMobile)],
                    ]);
                    grid.classList.add("kv-plain");
                    vList.appendChild(grid);
                    if (i < vehicles.length - 1) vList.appendChild(el("hr", "sub-divider"));
                });
                cards.appendChild(makeCollapsibleCard("財車資料", vList, vehicles.length, false));
                const nonV = Array.isArray(data.nonVehicles) ? data.nonVehicles : [];
                const nList = el("div", "sub-collection");
                nonV.forEach((nv, i) => {
                    nList.appendChild(el("div", "item-title", `非財車 ${i + 1}`));
                    const grid = makeKVGrid([
                        ["非車輛財損", safe(nv.pdNonVehicle)],
                        ["肇責比例", safe(nv.pdAccLibilityPcnt)],
                        ["物主姓名", safe(nv.ownerNm)],
                        ["物主電話", safe(nv.ownerTEL)],
                    ]);
                    grid.classList.add("kv-plain");
                    nList.appendChild(grid);
                    if (i < nonV.length - 1) nList.appendChild(el("hr", "sub-divider"));
                });
                cards.appendChild(makeCollapsibleCard("非財車資料", nList, nonV.length, false));
                const vV = Array.isArray(data.victimsV) ? data.victimsV : [];
                const vVList = el("div", "sub-collection");
                vV.forEach((vv, i) => {
                    vVList.appendChild(el("div", "item-title", `受害人(任意) ${i + 1}`));
                    const grid = makeKVGrid([
                        ["傷情代號", safe(vv.victimDamageTypCD)],
                        ["肇責比例", safe(vv.victimAccLibilityPcnt)],
                        ["姓名", safe(vv.victimNm)],
                        ["行動電話", telify(vv.victimMobile)],
                        ["性別", safe(vv.victimSex)],
                    ]);
                    grid.classList.add("kv-plain");
                    vVList.appendChild(grid);
                    if (i < vV.length - 1) vVList.appendChild(el("hr", "sub-divider"));
                });
                cards.appendChild(makeCollapsibleCard("受害人-任意", vVList, vV.length, false));
                const vC = Array.isArray(data.victimsC) ? data.victimsC : [];
                const vCList = el("div", "sub-collection");
                vC.forEach((vc, i) => {
                    vCList.appendChild(el("div", "item-title", `受害人(強制) ${i + 1}`));
                    const grid = makeKVGrid([
                        ["傷情代號", safe(vc.victimDamageTypCD)],
                        ["肇責比例", safe(vc.victimAccLibilityPcnt)],
                        ["姓名", safe(vc.victimNm)],
                        ["行動電話", telify(vc.victimMobile)],
                        ["性別", safe(vc.victimSex)],
                    ]);
                    grid.classList.add("kv-plain");
                    vCList.appendChild(grid);
                    if (i < vC.length - 1) vCList.appendChild(el("hr", "sub-divider"));
                });
                cards.appendChild(makeCollapsibleCard("受害人-強制", vCList, vC.length, false));
            }

            // ======= 頁籤:承保資料 =======
            function renderCoverage() {
                const wrap = document.getElementById("policyCoverageWrap");
                wrap.innerHTML = "";
                const arr = Array.isArray(data.policyCoverage) ? data.policyCoverage : [];
                if (!arr.length) {
                    wrap.textContent = "—";
                    return;
                }
                const totalPrm = arr.reduce((sum, p) => sum + (Number(String(p.coverageInsPrm).replace(/[^0-9.-]/g, "")) || 0), 0);
                wrap.appendChild(el("div", "coverage-total", `總保險費 ${Number(totalPrm).toLocaleString("zh-TW")} 元`));
                arr.forEach((p, i) => {
                    const titleTxt =
                        [p.coverageCD, p.coverageDesc]
                            .map((x) => (x == null || x === "" ? null : String(x)))
                            .filter(Boolean)
                            .join(" ") || `承保項目 ${i + 1}`;
                    const box = el("div", "sub-card");
                    box.appendChild(el("div", "sub-title", titleTxt));
                    const kv = el("div", "kv kv-two");
                    const frag = document.createDocumentFragment();
                    [
                        ["給付項目", p.coverageInsAmtDesc],
                        ["保險金額", p.coverageInsAmt],
                        ["自負額", p.coverageDeduct],
                        ["保險費", p.coverageInsPrm],
                    ].forEach(([k, v]) => {
                        frag.appendChild(el("div", "k", k));
                        frag.appendChild(el("div", "v", text(v)));
                    });
                    kv.appendChild(frag);
                    box.appendChild(kv);
                    wrap.appendChild(box);
                });
                const contents = Array.isArray(data.policyContents) ? data.policyContents : [];
                if (contents.length) {
                    wrap.appendChild(el("div", "sub-title", "保單紀錄內容"));
                    const ul = el("ul", "plain-list");
                    contents.forEach((c) => ul.appendChild(el("li", "", text(c))));
                    wrap.appendChild(ul);
                }
            }

            // ======= 日誌：合併時間線 + 下拉 + 全展開/收合 =======
            function normalizeTimeline({ journal = [], transLog = [] }) {
                const J = journal.map((j) => ({
                    kind: "JOURNAL",
                    ts: j.inputDt || j.handleDt || j.handleelDt,
                    title: j.handleItemDesc || j.handleelItemDesc || "處理日誌",
                    actor: j.handlerUsrNm || j.inputUsrNm,
                    actorId: j.handlerUsrID || j.inputUsrID,
                    contact: j.contactNm,
                    content: j.contentMatters,
                    raw: j,
                }));
                const T = transLog.map((t) => ({
                    kind: "TRANS",
                    ts: t.inputDt,
                    title: t.tranDesc || "系統異動",
                    subTitle: t.reasonDesc,
                    as400No: t.tranNo || t.TranNo,
                    userAcct: t.hostUsrAcnt,
                    userName: t.hostUsrNm,
                    premiumCls: (t.premiumCls || "").trim(),
                    reserveCD: (t.reserveCD || "").trim(),
                    amounts: { lossPaid: t.lossPaid, revbal: t.revbal, chgbal: t.chgbal },
                    raw: t,
                }));
                return [...J, ...T]
                    .filter((e) => e.ts)
                    .sort((a, b) => tsToNumber(b.ts) - tsToNumber(a.ts))
                    .reverse();
            }
            function tsToNumber(s) {
                if (!s) return 0;
                const str = String(s).replace(/[^0-9]/g, "");
                if (str.length >= 14) {
                    return Number(str.slice(0, 14));
                }
                if (str.length >= 8) {
                    return Number(str.slice(0, 8) + "000000");
                }
                return Number(str) || 0;
            }
            function fmtTS(s) {
                if (!s) return "—";
                const d = String(s).replace(/[^0-9]/g, "");
                if (d.length >= 14) {
                    return `${d.slice(0, 4)}-${d.slice(4, 6)}-${d.slice(6, 8)} ${d.slice(8, 10)}:${d.slice(10, 12)}`;
                }
                if (d.length >= 8) {
                    return `${d.slice(0, 4)}-${d.slice(4, 6)}-${d.slice(6, 8)}`;
                }
                return s;
            }
            const PROCESS_ITEMS = [
                "Notification 損失通知",
                "Coverage 承保範圍",
                "Initial Contact 初次聯絡",
                "Investigation 事故調查",
                "Case Strategy 賠案處理策略",
                "Vendor Mgmt 協力廠商管理",
                "Evaluation 各項賠款估價",
                "Counter Fraud 反詐欺",
                "Reserving 預估損失金額",
                "Neg & Settlem 談判處理",
                "Litig. Mgmt 訴訟管理",
                "Recovery 追償",
                "File Mgmt 檔案管理",
                "Quality Assurance 賠案稽核",
                "SMS 發送簡訊",
                "系統自動通知",
                "Line推播",
                "客戶文件上傳/留言",
                "Auto Log賠案異動自動記錄",
                "賠案登錄",
                "賠案修正",
            ];
            const journalState = { filter: "ALL", query: "", process: "ALL" };

            function renderJournal() {
                const wrap = document.getElementById("journalWrap");
                wrap.innerHTML = "";

                const itemsAll = normalizeTimeline({ journal: data.journal || [], transLog: data.transLog || [] });
                const counts = { ALL: itemsAll.length, JOURNAL: itemsAll.filter((x) => x.kind === "JOURNAL").length, TRANS: itemsAll.filter((x) => x.kind === "TRANS").length };

                const bar = el("div", "toolbar");
                ["ALL", "JOURNAL", "TRANS"].forEach((k) => {
                    const map = { ALL: "全部", JOURNAL: "人工日誌", TRANS: "系統異動" };
                    const chip = el("span", "chip" + (journalState.filter === k ? " active" : ""), `${map[k]} ${counts[k]}`);
                    chip.addEventListener("click", () => {
                        journalState.filter = k;
                        renderJournal();
                    });
                    bar.appendChild(chip);
                });
                const actions = el("div", "bar-actions");
                const btnOpen = el("button", "link-xs", "全部展開");
                const btnClose = el("button", "link-xs", "全部收合");
                btnOpen.addEventListener("click", () => expandAll(true));
                btnClose.addEventListener("click", () => expandAll(false));
                actions.appendChild(btnOpen);
                actions.appendChild(btnClose);
                bar.appendChild(actions);
                wrap.appendChild(bar);

                const selWrap = el("div", "select-wrap");
                const sel = document.createElement("select");
                ["ALL", ...PROCESS_ITEMS].forEach((label) => {
                    const opt = document.createElement("option");
                    opt.value = label;
                    opt.textContent = label === "ALL" ? "全部處理項目" : label;
                    if (label === journalState.process) opt.selected = true;
                    sel.appendChild(opt);
                });
                sel.addEventListener("change", () => {
                    journalState.process = sel.value;
                    renderJournal();
                });
                selWrap.appendChild(sel);
                wrap.appendChild(selWrap);

                const searchTgl = el("button", "search-toggle", "片語搜尋");
                wrap.appendChild(searchTgl);
                const searchBox = el("div", "search-box");
                const inp = document.createElement("input");
                inp.placeholder = "輸入關鍵字，如 處理人、處理項目、AS400序號… 按 Enter 搜尋";
                inp.value = journalState.query || "";
                inp.addEventListener("keydown", (e) => {
                    if (e.key === "Enter") {
                        journalState.query = inp.value.trim();
                        renderJournal();
                    }
                });
                searchBox.appendChild(inp);
                wrap.appendChild(searchBox);
                searchTgl.addEventListener("click", () => {
                    searchBox.classList.toggle("open");
                    if (searchBox.classList.contains("open")) inp.focus();
                });

                let items = itemsAll.slice();
                if (journalState.filter !== "ALL") items = items.filter((x) => x.kind === journalState.filter);
                if (journalState.process !== "ALL") {
                    const key = journalState.process.toLowerCase();
                    items = items.filter((x) => (x.title || "").toLowerCase().includes(key) || (x.subTitle || "").toLowerCase().includes(key));
                }
                const q = (journalState.query || "").toLowerCase();
                if (q) {
                    items = items.filter((it) => {
                        const pool = [it.title, it.subTitle, it.actor, it.as400No, it.userAcct, it.userName, it.premiumCls, it.reserveCD, it.content, it.amounts ? it.amounts.lossPaid + " " + it.amounts.revbal + " " + it.amounts.chgbal : ""]
                            .join(" ")
                            .toLowerCase();
                        return pool.includes(q);
                    });
                }

                const tl = el("div", "timeline");
                if (!items.length) {
                    tl.appendChild(el("div", "muted", "沒有符合條件的紀錄。"));
                    wrap.appendChild(tl);
                    return;
                }
                items.forEach((it) => {
                    const row = el("div", "t-item");
                    row.appendChild(el("div", "t-time", fmtTS(it.ts)));
                    const card = el("section", "t-card");
                    const head = el("div", "t-head");
                    head.appendChild(el("div", "t-title", it.title || (it.kind === "TRANS" ? "系統異動" : "處理日誌")));
                    const right = el("div");
                    right.appendChild(el("span", "badge-src " + (it.kind === "TRANS" ? "system" : "manual"), it.kind === "TRANS" ? "系統" : "人工"));
                    const btn = el("button", "link-xs", "詳細");
                    right.appendChild(btn);
                    head.appendChild(right);
                    card.appendChild(head);

                    const body = el("div", "t-body");
                    body.style.display = "none";
                    const grid = el("div", "kv kv-two kv-plain");
					if (it.kind === "JOURNAL") {
					  const j = it.raw || {}; // 原始日誌物件，欄位名跟你的 JSON 一致
					  const pairs = [
						["處理項目", it.title],
						["處理項目代碼", j.handleItemCD || j.handleelItemCD],
						["處理人員", it.actor || "—"],
						["處理人員ID", it.actorId || j.handlerUsrID || j.inputUsrID],
						["聯絡對象", it.contact || j.contactNm],
						["建立人員", (j.inputUsrNm ? j.inputUsrNm + " " : "") + (j.inputUsrID || "")],
						["內容", it.content || j.contentMatters],
						// 需要別的，就照這格式繼續加：
						// ["你要的欄位名", j.你的JSON欄位],
					  ].filter(([, v]) => v != null && String(v).trim() !== "");

					  pairs.forEach(([k, v]) => {
						grid.appendChild(el("div", "k", k));
						grid.appendChild(el("div", "v", String(v)));
					  });
                    } else {
                        const t = it.raw || {};
                        [
                            ["異動類型", it.title],
                            ["說明", it.subTitle || "—"],
                            ["AS400序號", it.as400No || "—"],
                            ["使用者", (it.userName ? it.userName + " " : "") + (it.userAcct || "") || "—"],
                            ["險別", it.premiumCls || "—"],
                            ["類別", it.reserveCD || "—"],
                            ["已決", t.lossPaid || "—"],
                            ["未決", t.revbal || "—"],
                            ["異動", t.chgbal || "—"],
                        ].forEach(([k, v]) => {
                            grid.appendChild(el("div", "k", k));
                            grid.appendChild(el("div", "v", v == null ? "—" : String(v)));
                        });
                    }
                    body.appendChild(grid);
                    btn.addEventListener("click", () => {
						const open = body.style.display === "none";
						body.style.display = open ? "" : "none";
						btn.textContent = open ? "收合" : "詳細";
                    });
                    card.appendChild(body);
                    row.appendChild(card);
                    tl.appendChild(row);
                });
                wrap.appendChild(tl);
            }

            function expandAll(open) {
                document.querySelectorAll("#journalWrap .t-body").forEach((b) => {
                    b.style.display = open ? "" : "none";
                });
                document.querySelectorAll("#journalWrap .t-head .link-xs").forEach((btn) => {
                    btn.textContent = open ? "收合" : "詳細";
                });
            }

            function initTabs() {
                const tabBtns = document.querySelectorAll(".tab-btn");
                const panels = document.querySelectorAll(".tab-panel");
                tabBtns.forEach((btn) => {
                    btn.addEventListener("click", () => {
                        tabBtns.forEach((b) => b.setAttribute("aria-selected", String(b === btn)));
                        panels.forEach((p) => p.classList.remove("active"));
                        const pid = btn.getAttribute("aria-controls");
                        document.getElementById(pid).classList.add("active");
                    });
                });
            }

            document.addEventListener("DOMContentLoaded", () => {
                renderHeader();
                renderBasic();
                renderAccident();
                renderCoverage();
                renderJournal();
                initTabs();
            });
        </script>
    </body>
</html>
