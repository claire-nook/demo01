<!DOCTYPE html>
<html lang="zh-Hant">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>查詢作業 - API呼叫記錄 - 明細 (日誌新增)</title>
        <style>
            :root {
                color-scheme: light;
            }
            html,
            body {
                margin: 0;
                padding: 0;
                font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", Arial, sans-serif;
                background: #f6f7fb;
            }
            h2 {
                margin: 0 0 0.75rem 0;
                font-size: 1.25rem;
            }
            .container {
                padding: 1rem;
            }
            .pc-wrapper {
                display: block;
            }
            .mobile-wrapper {
                display: none;
            }
            .card {
                background: #fff;
                border-radius: 12px;
                padding: 1rem;
                margin-bottom: 1rem;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            }
            .row-flex {
                display: flex;
                gap: 1rem;
                margin-bottom: 0.75rem;
            }
            .col {
                flex: 1;
                min-width: 0;
            }
            .label {
                font-size: 0.85rem;
                color: #6b7280;
                margin-bottom: 0.25rem;
                display: block;
            }
            .val {
                font-weight: 600;
                color: #111;
                word-break: break-all;
            }
            .kv {
                color: #6b7280;
                font-size: 0.9rem;
            }
            .grid-2 {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 1rem;
            }
            .mono {
                font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
            }
            .muted {
                color: #6b7280;
                font-size: 0.9rem;
            }
            .badge {
                display: inline-block;
                font-size: 0.8rem;
                padding: 0.15rem 0.5rem;
                border: 1px solid #d1d5db;
                border-radius: 999px;
                color: #374151;
                background: #fff;
            }
            .badge.ok {
                color: #166534;
                border-color: #86efac;
            }
            .badge.fail {
                color: #991b1b;
                border-color: #fca5a5;
            }
            .badge.progress {
                color: #1e3a8a;
                border-color: #93c5fd;
            }
            .btn-area {
                display: flex;
                gap: 0.75rem;
                justify-content: center;
                flex-wrap: wrap;
                margin-top: 0.5rem;
            }
            .btn {
                padding: 0.6rem 1.2rem;
                border: 0;
                border-radius: 8px;
                font-weight: 700;
                cursor: pointer;
            }
            .btn-gray {
                background: #d1d5db;
                color: #111;
            }
            .btn-warn {
                background: #f59e0b;
                color: #111;
            }
            .btn-primary {
                background: #2f855a;
                color: #fff;
            }
            .table-wrap {
                width: 100%;
                overflow: auto;
            }
            table.table {
                width: 100%;
                border-collapse: collapse;
                table-layout: fixed;
            }
            .table th,
            .table td {
                border-bottom: 1px solid #e5e7eb;
                padding: 0.5rem 0.4rem;
                text-align: left;
                vertical-align: top;
            }
            .table th {
                color: #6b7280;
                font-weight: 600;
            }
            .kpi {
                display: flex;
                gap: 0.75rem;
                flex-wrap: wrap;
            }
            .kpi .pill {
                background: #f3f4f6;
                border-radius: 999px;
                padding: 0.25rem 0.6rem;
                font-size: 0.85rem;
                color: #374151;
            }
            .section-title {
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 0.5rem;
                margin-bottom: 0.5rem;
            }
            .meta {
                color: #6b7280;
                font-size: 0.85rem;
            }
            .note-content {
                white-space: pre-wrap;
                line-height: 1.5;
                padding: 0.5rem;
                background: #f9fafb;
                border-radius: 8px;
            }
            .chips {
                display: flex;
                flex-wrap: wrap;
                gap: 0.5rem;
                margin-top: 0.25rem;
            }
            .chip {
                background: #e5e7eb;
                border-radius: 999px;
                padding: 0.25rem 0.6rem;
                font-size: 0.85rem;
            }
            @media screen and (max-width: 767px) {
                .pc-wrapper {
                    display: none;
                }
                .mobile-wrapper {
                    display: block;
                }
                .grid-2 {
                    grid-template-columns: 1fr;
                }
                .row-flex {
                    flex-direction: column;
                    gap: 0.5rem;
                }
                .btn {
                    width: 100%;
                    padding: 0.8rem 1rem;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <!-- Header -->
            <div class="card">
                <div class="row-flex">
                    <div class="col">
                        <h2>API呼叫記錄 明細 (日誌新增) <span id="statusBadge" class="badge">狀態</span></h2>
                        <div class="meta" id="auditInfo">建立：— ・ 最後異動：—</div>
                    </div>
                    <div class="col" style="text-align: right;">
                        <div class="kpi" style="justify-content: flex-end;" id="kpiRight"></div>
                    </div>
                </div>
            </div>

            <!-- 請求總覽 -->
            <div class="card">
                <div class="section-title"><strong>請求總覽</strong></div>
                <div class="grid-2">
                    <div>
                        <div class="label">請求序號</div>
                        <div class="val mono" id="oid">—</div>
                    </div>
                    <div>
                        <div class="label">請求時間</div>
                        <div class="val" id="reqTime">—</div>
                    </div>
                    <div>
                        <div class="label">請求人員</div>
                        <div class="val" id="reqStaff">—</div>
                    </div>
                    <div>
                        <div class="label">處理狀態</div>
                        <div class="val" id="reqStatusWrap">—</div>
                    </div>
                    <div>
                        <div class="label">來源</div>
                        <div class="val" id="srcCode">—</div>
                    </div>
                    <div>
                        <div class="label">API 類型</div>
                        <div class="val" id="apiType">—</div>
                    </div>
                    <div>
                        <div class="label">賠案號碼</div>
                        <div class="val mono" id="claimNo">—</div>
                    </div>
                    <div>
                        <div class="label">任務編號</div>
                        <div class="val mono" id="taskOid">—</div>
                    </div>
                    <div>
                        <div class="label">是否關聯任務</div>
                        <div class="val" id="hasTask">—</div>
                    </div>
                </div>
            </div>

            <!-- 呼叫時間軸 -->
            <div class="card">
                <div class="section-title">
                    <strong>呼叫時間軸</strong>
                    <div class="kpi" id="callKpi"></div>
                </div>
                <div class="pc-wrapper">
                    <div class="table-wrap">
                        <table class="table" id="callTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>呼叫時間</th>
                                    <th>回應時間</th>
                                    <th>狀態</th>
                                    <th>代碼</th>
                                    <th>訊息</th>
                                    <th>回應序號</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <div class="mobile-wrapper" id="callCards"></div>
            </div>

            <!-- 動態卡片: 日誌內容 -->
            <div class="card" id="noteCard">
                <div class="section-title"><strong>日誌內容</strong></div>
                <div class="grid-2">
                    <div>
                        <div class="label">處理事項</div>
                        <div class="val" id="pitem">—</div>
                    </div>
                    <div>
                        <div class="label">被聯絡人</div>
                        <div class="val" id="contact">—</div>
                    </div>
                </div>
                <div class="label" style="margin-top: 0.5rem;">內容</div>
                <div class="note-content" id="content">—</div>
                <div class="label" style="margin-top: 0.75rem;">通知人員</div>
                <div class="muted" id="notifyListText">—</div>
            </div>

            <!-- 操作區塊 -->
            <div class="card">
                <div class="section-title"><strong>操作與連結</strong></div>
                <div class="btn-area">
                    <button class="btn btn-warn" id="btnResend">重送</button>
                    <button class="btn btn-gray" onclick="goBack()">返回查詢</button>
                </div>
            </div>
        </div>

        <script>
            function badgeStatus(s) {
                const map = { 0: ["progress", "待處理"], 1: ["ok", "成功"], 2: ["fail", "失敗"], 3: ["fail", "逾時"], 4: ["fail", "取消"], 5: ["progress", "處理中"] };
                const v = map[s] || ["", "未知"];
                return `<span class="badge ${v[0]}">${s} ${v[1]}</span>`;
            }

            const SAMPLE = {
                LOG_COREAPI: {
                    OID: 101,
                    REQ_TIME: "2025/08/21 09:12:33",
                    SRC_CODE: "TASK",
                    API_TYPE: 1,
                    CLAIM_NO: "01078966",
                    OID_REQ_STAFF: "張三",
                    OID_CLM_TASK: 551,
                    HAS_RELATED_TASK: "Y",
                    REQ_STATUS: 1,
                    CREATE_INFO: "建立：2025/08/21 09:12:40（張三）",
                    UPDATE_INFO: "最後異動：2025/08/21 09:12:50（系統）",
                },
                LOG_COREAPI_CALL: [{ SEQ: 1, CALL_TIME: "09:12:42", RETURN_TIME: "09:12:49", STATUS: 1, CODE: "000", MSG: "呼叫成功", DUR: 150, SERIAL: 21532 }],
                LOG_COREAPI_NOTE: {
                    PITEM_CODE: "勘車",
                    NOTE_CONTACTNM: "王五",
                    NOTE_CONTENT: "任務現場已完成拍照與聯絡，被保人知悉。但這個內容可能會很長，因為要測試折行，所以內容非常非常非常非常非常非常非常非常非常非常非常非常非常非常非常非常非常非常非常非常非常非常非常非常非常非常非常多。",
                    NOTIFY_LIST_JSON: '[{"name":"陳六","email":"a@example.com"},{"name":"林八","email":"b@example.com"}]',
                    NOTIFY_SUMMARY: "陳六 a@example.com; 林八 b@example.com",
                },
            };

            function render() {
                const g = SAMPLE.LOG_COREAPI;
                document.getElementById("auditInfo").textContent = `${g.CREATE_INFO} ・ ${g.UPDATE_INFO}`;
                document.getElementById("statusBadge").outerHTML = badgeStatus(g.REQ_STATUS);
                document.getElementById("oid").textContent = g.OID;
                document.getElementById("reqTime").textContent = g.REQ_TIME;
                document.getElementById("srcCode").textContent = g.SRC_CODE;
                document.getElementById("apiType").textContent = `${g.API_TYPE} 日誌新增`;
                document.getElementById("claimNo").textContent = g.CLAIM_NO;
                document.getElementById("reqStaff").textContent = g.OID_REQ_STAFF;
                document.getElementById("taskOid").textContent = g.OID_CLM_TASK;
                document.getElementById("hasTask").textContent = g.HAS_RELATED_TASK === "Y" ? "是" : "否";
                document.getElementById("reqStatusWrap").innerHTML = badgeStatus(g.REQ_STATUS);

                const calls = SAMPLE.LOG_COREAPI_CALL;
                const tb = document.querySelector("#callTable tbody");
                tb.innerHTML = calls.map((r) => `<tr>
													<td>${r.SEQ}</td>
													<td>${r.CALL_TIME}</td>
													<td>${r.RETURN_TIME}</td>
													<td>${badgeStatus(r.STATUS)}</td>
													<td>${r.CODE}</td>
													<td>${r.MSG}</td>
													<td>${r.SERIAL}</td>
												</tr>`
										).join("");
                document.getElementById("callCards").innerHTML = calls
                    .map(
                        (r) =>
                            `<div class=card>
								<div><span class=kv>#</span> ${r.SEQ}</div>
								<div><span class=kv>呼叫</span> ${r.CALL_TIME}</div>
								<div><span class=kv>回應</span> ${r.RETURN_TIME}</div>
								<div><span class=kv>狀態</span> ${badgeStatus(r.STATUS)}</div>
								<div><span class=kv>代碼</span> ${r.CODE}</div>
								<div><span class=kv>訊息</span> ${r.MSG}</div>
								<div><span class=kv>回應序號</span> ${r.SERIAL}ms</div>
							</div>`
                    )
                    .join("");

                const note = SAMPLE.LOG_COREAPI_NOTE;
                document.getElementById("pitem").textContent = note.PITEM_CODE;
                document.getElementById("contact").textContent = note.NOTE_CONTACTNM;
                document.getElementById("content").textContent = note.NOTE_CONTENT;
                // 通知人員：統一以純文字顯示
                (function () {
                    let display = note.NOTIFY_SUMMARY || "";
                    try {
                        const list = JSON.parse(note.NOTIFY_LIST_JSON || "[]");
                        if (Array.isArray(list) && list.length) {
                            display = list
                                .map((x) => {
                                    const name = (x.name || "").trim();
                                    const email = (x.email || "").trim();
                                    const code = x.userCode ? `（${x.userCode}）` : "";
                                    return `${name} ${email}${code}`.trim();
                                })
                                .join("； ");
                        }
                    } catch (e) {}
                    document.getElementById("notifyListText").textContent = display || "未指定通知對象";
                })();
            }

            function goBack() {
				location.href = "08.log_coreapi_query.html";
            }
            document.addEventListener("DOMContentLoaded", render);
        </script>
    </body>
</html>
